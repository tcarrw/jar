<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Jar — Day</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Today’s Illumina track with notes and a gentle, compact player.">
<style>
  :root{
    --bg:#0B0F19;--ink:#EAECEF;--muted:#AAB2C0;--line:rgba(229,231,235,.16);--card:#0F1524;
    --gold:#F5D142;--ok:#34D399;--err:#F87171;--maxw:1100px;--r:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);
       font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Inter,Roboto,Arial}
  a{color:var(--gold);text-decoration:none} a:hover{text-decoration:underline}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:16px 16px 48px}
  /* Sticky header with compact player */
  header{position:sticky;top:0;z-index:50;background:rgba(11,15,25,.96);
         backdrop-filter:saturate(140%) blur(8px);border-bottom:1px solid var(--line)}
  .head{display:grid;grid-template-columns:1fr 460px;gap:14px;align-items:center;padding:10px 16px}
  @media (max-width:980px){.head{grid-template-columns:1fr}}
  h1{margin:0;font-size:22px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:6px 10px;border-radius:999px;border:1px solid var(--line);font-size:12px;color:#cfd3db}
  .select{appearance:none;background:rgba(255,255,255,.02);color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:8px 12px}
  .player{position:relative;height:clamp(200px,34vh,320px);border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000}
  .player iframe{width:100%;height:100%;border:0}
  /* Controls with aligned high-contrast arrows */
  .controls{display:flex;gap:10px;align-items:center;margin-top:10px}
  .navbtn{display:inline-flex;align-items:center;gap:8px;line-height:1;border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.03);color:var(--ink);cursor:pointer}
  .navbtn.primary{background:linear-gradient(180deg,rgba(245,209,66,.15),rgba(245,158,11,.12));border-color:rgba(245,158,11,.35)}
  .navbtn .icon{display:inline-flex;width:16px;height:16px}
  .navbtn .icon svg{display:block;width:16px;height:16px;fill:none;stroke:currentColor;stroke-width:2;stroke-linecap:round;stroke-linejoin:round}
  /* Layout */
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0));border:1px solid var(--line);border-radius:14px;padding:14px}
  .card h3{margin:0 0 6px;font-size:18px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:rgba(255,255,255,.02)}
  .big{font-size:28px;line-height:1.1;font-weight:800;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .footer{margin-top:18px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  /* Hide the developer queue for the public view */
  #queueSection{display:none}
</style>
</head>
<body>
<header>
  <div class="head wrap">
    <div>
      <h1 id="dayTitle">Day —</h1>
      <div class="row" aria-label="Day facts">
        <span id="dateOut" class="pill">—</span>
        <span id="phaseOut" class="pill">—</span>
        <label class="pill" for="plist">
          Version:
          <select id="plist" class="select">
            <option value="explainer">Explainer</option>
            <option value="anchorPublic">Anchor · Public</option>
            <option value="anchorBuilt">Anchor · Built</option>
          </select>
        </label>
        <a class="pill" href="https://tunes.plnt.earth/">Tunes</a>
        <a class="pill" href="https://jar.plnt.earth/interludes/">Interludes</a>
        <a class="pill" href="https://tunes.plnt.earth/beacon/index.html">Beacon</a>
      </div>
      <div class="controls">
        <button id="prevBtn" class="navbtn" title="Previous (⌥←)" aria-label="Previous">
          <span class="icon" aria-hidden="true"><svg viewBox="0 0 20 20"><path d="M12.5 3.5L6 10l6.5 6.5"/></svg></span>
          <span>Prev</span>
        </button>
        <button id="nextBtn" class="navbtn primary" title="Next (⌥→)" aria-label="Next">
          <span>Next</span>
          <span class="icon" aria-hidden="true"><svg viewBox="0 0 20 20"><path d="M7.5 3.5L14 10l-6.5 6.5"/></svg></span>
        </button>
        <a class="navbtn" id="openInYT" target="_blank" rel="noopener" aria-label="Open on YouTube">Open on YouTube</a>
      </div>
    </div>
    <div class="player" id="playerBox" aria-label="Video player"></div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card" id="nowCard">
      <h3>Now Playing</h3>
      <div id="trackTitle" class="big">—</div>
      <div class="chips" style="margin-top:8px">
        <span id="artistChip" class="chip">Artist —</span>
        <span id="seedChip" class="chip">Seed —</span>
        <span id="figureChip" class="chip">Figure —</span>
        <span id="phaseChip" class="chip">Phase —</span>
      </div>
      <div class="mono" id="urlOut" style="margin-top:8px">—</div>
    </section>

    <aside class="card">
      <h3>Daily Task / Ritual</h3>
      <div id="taskText" class="muted">—</div>
      <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
      <h3>Notes</h3>
      <div id="notes" class="muted">—</div>
    </aside>
  </div>

  <section id="queueSection" class="card" style="margin-top:14px">
    <h3>Queue</h3>
    <div id="queue" class="mono">—</div>
  </section>

  <div class="footer">
    <div>© <span id="yy"></span> PLNT.earth — Jar Day</div>
    <div><a href="/map/">Constellation</a> • <a href="https://tunes.plnt.earth/beacon/index.html" target="_blank" rel="noopener">Beacon</a></div>
  </div>
</div>

<script>
/* ===== URL & state ===== */
const QS = new URLSearchParams(location.search);
const DAYQ = parseInt(QS.get("day")||"0",10) || null;
const DATEQ = QS.get("date") || null;
const PLAYLISTQ = (QS.get("playlist")||"explainer").toLowerCase();

/* ===== Elements ===== */
const yyEl = document.getElementById('yy'); yyEl.textContent = new Date().getFullYear();
const plistEl = document.getElementById('plist'); plistEl.value = PLAYLISTQ;
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
plistEl.addEventListener('change', () => { const u=new URL(location.href); u.searchParams.set('playlist', plistEl.value); location.href=u.toString(); });

/* ===== UTF fixes ===== */
const NAME_FIX = new Map([["beyonce","Beyoncé"],["beyoncé","Beyoncé"],["maneskin","Måneskin"],["måneskin","Måneskin"],["chloe","Chlöe"],["chloë","Chloë"],["rosalia","Rosalía"],["jose gonzalez","José González"]]);
function fixName(raw){ if(!raw) return ""; const n=raw.normalize?raw.normalize('NFC'):raw; const k=n.trim().toLowerCase(); return NAME_FIX.get(k)||n; }
function fixMojibake(s){ if(typeof s!=="string") return s; return s.normalize('NFC').replace(/BeyoncÃ©/gi,'Beyoncé').replace(/MÃ¥neskin/gi,'Måneskin').replace(/’/g,'’'); }
function deepFix(o){ if(Array.isArray(o)) return o.map(deepFix); if(o&&typeof o==='object'){const x={}; for(const k in o) x[k]=deepFix(o[k]); return x;} return fixMojibake(o); }

/* ===== Data sources ===== */
const MASTER_URL = "/Illumina1_Playlist_MASTER_3in1.json"; // preferred
const LEGACY_URL = "/data/illumina1.json";                  // fallback
const TASKS_URL  = "/data/illumina1_tasks.json";            // optional per‑track tasks/rituals

async function fetchJSON(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw 0; return deepFix(await r.json()); }
async function loadModel(){
  try{ const m = await fetchJSON(MASTER_URL); if(m && Array.isArray(m.days)) return { type:'master', data:m }; }catch{}
  const l = await fetchJSON(LEGACY_URL); return { type:'legacy', data:l };
}
let TASKS=null;
(async()=>{ try{ TASKS = await fetchJSON(TASKS_URL); }catch{ TASKS=null; } })();

/* ===== Helpers ===== */
function safeURL(h){ try{ return new URL(h,'https://youtube.com').href; }catch{ return ''; } }
function vidFromURL(h){ try{ const u=new URL(h,'https://youtube.com'); return u.searchParams.get('v')||u.pathname.split('/').pop(); }catch{ return ''; } }
function selectDay(days){ if(DAYQ!=null && days[DAYQ-1]) return days[DAYQ-1]; if(DATEQ){ const d=days.find(x=>x.Date===DATEQ); if(d) return d; } return days[0]||null; }
function itemForPlaylist(day,key){ const map={explainer:'Explainer', anchorpublic:'AnchorPublic', anchorbuilt:'AnchorBuilt'}; return day ? day[map[key]||'Explainer'] : null; }

/* ===== Player & queue (hidden in UI) ===== */
let ytReady=false, player=null, queue=[], qIndex=0;
function renderYouTube(videoId){ const box=document.getElementById('playerBox'); const src=`https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&enablejsapi=1&modestbranding=1&playsinline=1`; box.innerHTML=`<iframe id="yt" src="${src}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`; setupYTAPI(); }
function setupYTAPI(){ if(window.YT&&YT.Player) return initYT(); const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; document.head.appendChild(s); window.onYouTubeIframeAPIReady=initYT; }
function initYT(){ if(ytReady) return; ytReady=true; player=new YT.Player('yt',{ events:{ onStateChange: ev=>{ if(ev.data===0) next(); } } }); }

function prev(){ if(queue.length===0) return; qIndex = Math.max(0, qIndex-1); playIndex(qIndex); }
function next(){ if(queue.length===0) return; qIndex = Math.min(queue.length-1, qIndex+1); playIndex(qIndex); }
prevBtn.onclick=prev; nextBtn.onclick=next;
window.addEventListener('keydown', e=>{ if(e.altKey && (e.key==='ArrowLeft')) prev(); if(e.altKey && (e.key==='ArrowRight')) next(); });

function playIndex(i){ const d=queue[i]; if(!d) return; if(player&&player.loadVideoById) player.loadVideoById(d.videoId); else renderYouTube(d.videoId); updateNow(d); }

/* ===== UI Update ===== */
function updateNow(day){
  let artist='—', title='—', url='';
  if(day.Track){ const t=(day.Track||'').trim(); const p=t.split('–'); artist=fixName((p[0]||'').trim()); title=(p[1]||t).trim(); url=day.URL||''; }
  else { const it=itemForPlaylist(day, plistEl.value); if(it){ artist=fixName(it.artist||''); title=(it.title||'—').trim(); url=(it.Platforms&&it.Platforms.YouTube&&it.Platforms.YouTube.url)||''; } }
  document.getElementById('dayTitle').textContent=`Day ${day.Day||'—'}`;
  document.getElementById('dateOut').textContent=day.Date||'—';
  document.getElementById('phaseOut').textContent=day.MoonPhase||'—';
  document.getElementById('phaseChip').textContent=day.MoonPhase||'—';
  document.getElementById('trackTitle').textContent=`${artist?artist+' — ':''}${title}`;
  document.getElementById('artistChip').textContent=artist||'—';
  document.getElementById('seedChip').textContent=day.SeedRitual||'—';
  document.getElementById('figureChip').textContent=day.Figure||'—';
  document.getElementById('urlOut').textContent=url||'—';
  document.getElementById('openInYT').href=url? safeURL(url) : 'https://youtube.com';
  document.getElementById('notes').textContent=day.Notes||'';

  // Resolve task/ritual text
  let task='';
  const k=plistEl.value; // explainer/anchorPublic/anchorBuilt
  if(day.Rituals && (day.Rituals[k]||day.Rituals.core)) task = day.Rituals[k]||day.Rituals.core;
  else if(day.Tasks && (day.Tasks[k]||day.Tasks.core)) task = day.Tasks[k]||day.Tasks.core;
  else if(day.Ritual) task = day.Ritual;
  else if(day.SeedRitual) task = day.SeedRitual;
  else if(TASKS && TASKS[day.Date] && (TASKS[day.Date][k]||TASKS[day.Date].core)) task = TASKS[day.Date][k]||TASKS[day.Date].core;
  document.getElementById('taskText').textContent = task || '—';
}

/* ===== Boot ===== */
(async ()=>{
  const {type, data} = await loadModel();
  const days = type==='master' ? (data.days||[]) : (data.Days||[]);
  const today = selectDay(days);
  if(!today){ updateNow({}); return; }

  // Build queue from today onward; skip items without YouTube URL for selected playlist
  const startIdx = (days.findIndex(d=>d.Date===today.Date)>=0)? days.findIndex(d=>d.Date===today.Date):0;
  const mapDay = d => {
    let url='';
    if(d.Track){ url=d.URL||''; }
    else { const it=itemForPlaylist(d, plistEl.value); url=(it&&it.Platforms&&it.Platforms.YouTube&&it.Platforms.YouTube.url)||''; }
    return {...d, videoId: vidFromURL(url)};
  };
  queue = days.slice(startIdx).filter(d=>{
    if(d.Track) return true;
    const it=itemForPlaylist(d, plistEl.value);
    const url=(it&&it.Platforms&&it.Platforms.YouTube&&it.Platforms.YouTube.url)||'';
    return !!url;
  }).map(mapDay);

  updateNow(queue[0]);
  renderYouTube(queue[0].videoId);
})();
</script>
</body>
</html>
