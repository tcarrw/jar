<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Jar — Day</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina Day player. Loads manifest and a single track JSON from /data/illumina/1.">
<style>
  :root{--bg:#0B0F19;--ink:#E6EAF2;--muted:#94A3B8;--line:rgba(255,255,255,.12);--card:#0F1524;--hi:#A4E8FF;--ok:#34D399;--warn:#FBBF24;--player-col:560px}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Inter,Roboto,Arial}
  a{color:#BBD7FF;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 48px}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0B0F19 70%,rgba(11,15,25,.85));border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(8px)}
  .head{display:grid;grid-template-columns:1fr var(--player-col);gap:14px;align-items:center;padding:10px 16px}
  body.dock-left .head{grid-template-columns:var(--player-col) 1fr}
  body.dock-inline .head{grid-template-columns:1fr}
  body.dock-inline #playerBox{display:none}
  body.dock-inline #playerInline{display:block}
  body.size-s{--player-col:420px}
  body.size-m{--player-col:560px}
  body.size-l{--player-col:720px}
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:13px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .player{position:relative;aspect-ratio:16/9;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000}
  .player iframe{width:100%;height:100%;border:0}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 40%),var(--card);font-weight:700;cursor:pointer}
  .select{appearance:none;background:linear-gradient(180deg,rgba(255,255,255,.06),rgba(255,255,255,.02)),var(--card);color:var(--ink);border:1px solid rgba(255,255,255,.28);border-radius:10px;padding:6px 10px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.02),transparent 40%),var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:rgba(255,255,255,.02)}
  .big{font-size:28px;line-height:1.1;font-weight:800;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .footer{margin-top:18px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  #playerInline{display:none;margin:12px 0 0 0}
</style>
</head>
<body class="dock-right size-m">
<script src="/api/config.js"></script>
<header>
  <div class="head wrap">
    <div>
      <h1 id="dayTitle">Day —</h1>
      <div class="row">
        <span id="dateOut" class="pill">—</span>
        <span id="phaseOut" class="pill">—</span>
        <label class="pill">Playlist:
          <select id="plist" class="select"></select>
        </label>
        <label class="pill">Dock:
          <select id="dockSel" class="select"><option value="right">Right</option><option value="left">Left</option><option value="inline">Inline</option></select>
        </label>
        <label class="pill">Size:
          <select id="sizeSel" class="select"><option value="s">S</option><option value="m" selected>M</option><option value="l">L</option></select>
        </label>
        <label class="pill"><input id="loop" type="checkbox" style="accent-color:#5eead4"> Loop</label>
      </div>
      <div class="controls">
        <button id="prevBtn" class="btn" title="Previous (⌥←)">⟵ Prev</button>
        <button id="nextBtn" class="btn" title="Next (⌥→)">Next ⟶</button>
        <a class="btn" id="openInYT" target="_blank" rel="noopener">Open on YouTube</a>
        <a class="btn" href="https://tunes.plnt.earth" target="_blank" rel="noopener">🎶 Tunes</a>
      </div>
    </div>
    <div class="player" id="playerBox"></div>
  </div>
</header>

<div class="wrap"><div class="player" id="playerInline"></div></div>

<div class="wrap">
  <div class="grid">
    <section class="card" id="nowCard">
      <h3>Now Playing</h3>
      <div id="trackTitle" class="big">—</div>
      <div class="chips" style="margin-top:8px">
        <span id="seedChip" class="chip">Seed —</span>
        <span id="figureChip" class="chip">Figure —</span>
        <span id="phaseChip" class="chip">Phase —</span>
      </div>
      <div class="mono" id="urlOut" style="margin-top:8px">—</div>
    </section>
    <aside class="card">
      <h3>Beacon (this week)</h3>
      <div id="beacon" class="muted">—</div>
    </aside>
  </div>
  <div class="footer">
    <div>© <span id="yy"></span> PLNT.earth — Jar Day</div>
    <div><a href="/map/">Constellation</a></div>
  </div>
</div>

<script>
(function(){
  document.getElementById('yy').textContent = new Date().getFullYear();
  var cfg = (window.ILLUMINA_CONFIG) || { baseUrl:"/data", activeIllumina:1, routes:{ manifest:function(n){return "/data/illumina/"+n+"/manifest.json";} } };
  var qs = new URLSearchParams(location.search);
  var DAYQ = parseInt(qs.get("day")||"0",10) || null;
  var DATEQ = qs.get("date") || null;
  var PLAYLISTQ = (qs.get("playlist")||'anchor-public').toLowerCase();

  var plistEl = document.getElementById('plist');
  var loopEl  = document.getElementById('loop');
  var prevBtn = document.getElementById('prevBtn');
  var nextBtn = document.getElementById('nextBtn');
  var dockSel = document.getElementById('dockSel');
  var sizeSel = document.getElementById('sizeSel');
  var openInYT = document.getElementById('openInYT');

  var manifestUrl = cfg.routes.manifest(cfg.activeIllumina);
  var manifest=null, lanes=[], laneId=PLAYLISTQ, items=[], queue=[], qIndex=0, currentId="", player=null, ytReady=false;

  function ujoin(base, rel){ try{ return new URL(rel, base).href; }catch(e){ return rel; } }
  function extractYouTubeID(u){ if(!u) return ""; var s=String(u); var m=s.match(/[?&]v=([^&]+)/)||s.match(/youtu\.be\/([^?&]+)/)||s.match(/embed\/([^?&]+)/); return m?m[1]:""; }
  function hostEl(){ return (document.body.classList.contains('dock-inline') ? document.getElementById('playerInline') : document.getElementById('playerBox')); }
  function renderYouTube(id){ var box=hostEl(); var src="https://www.youtube.com/embed/"+id+"?autoplay=1&rel=0&enablejsapi=1&modestbranding=1&playsinline=1"; box.innerHTML='<iframe id="yt" src="'+src+'" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>'; currentId=id; setupYTAPI(); }
  function setupYTAPI(){ if(window.YT&&YT.Player) return initYT(); var s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; document.head.appendChild(s); window.onYouTubeIframeAPIReady=initYT; }
  function initYT(){ ytReady=true; player=new YT.Player('yt',{events:{onStateChange:function(ev){ if(ev.data===0){ if(loopEl.checked){ if(player&&player.seekTo){ player.seekTo(0,true); player.playVideo(); } else { renderYouTube(currentId); } } else { next(); } } }}}); }

  function applyLayout(){
    var dock=dockSel.value, size=sizeSel.value;
    document.body.classList.toggle('dock-left', dock==='left');
    document.body.classList.toggle('dock-right', dock==='right');
    document.body.classList.toggle('dock-inline', dock==='inline');
    document.body.classList.toggle('size-s', size==='s');
    document.body.classList.toggle('size-m', size==='m');
    document.body.classList.toggle('size-l', size==='l');
    if(currentId){ renderYouTube(currentId); }
    try{ localStorage.setItem('jar.day.layout', dock); localStorage.setItem('jar.day.size', size); }catch(e){}
  }
  (function restore(){ try{ dockSel.value=localStorage.getItem('jar.day.layout')||'right'; sizeSel.value=localStorage.getItem('jar.day.size')||'m'; }catch(e){} applyLayout();})();
  dockSel.addEventListener('change', applyLayout); sizeSel.addEventListener('change', applyLayout);

  function beaconForDay(n){ var idx=Math.floor((+n-1)/7); var names=['Voice','Honey','Stage','Cosmos','Neon','Edge']; var icons=['📣','🍯','🎭','🌌','🕺','🗡️']; return (idx>=0 && idx<6)?(icons[idx]+' '+names[idx]):'—'; }

  function updateNow(it){
    document.getElementById('dayTitle').textContent = 'Day '+(it.day||'—');
    document.getElementById('dateOut').textContent = it.date||'—';
    document.getElementById('phaseOut').textContent = it.moonPhase||'—';
    document.getElementById('phaseChip').textContent = it.moonPhase||'—';
    document.getElementById('trackTitle').textContent = it.title||'—';
    document.getElementById('seedChip').textContent = it.seedRitual||'—';
    document.getElementById('figureChip').textContent = it.figure||'—';
    var yt = it.urls && it.urls.youtube || '';
    document.getElementById('urlOut').textContent = yt||'—';
    openInYT.href = yt || 'https://youtube.com';
    document.getElementById('beacon').textContent = beaconForDay(it.day||1);
  }

  function play(i){
    var it = queue[i]; if(!it) return;
    var id = extractYouTubeID(it.urls && it.urls.youtube || '');
    if(player && player.loadVideoById){ player.loadVideoById(id); currentId=id; } else { renderYouTube(id); }
    qIndex = i; updateNow(it);
  }
  function prev(){ if(queue.length===0) return; qIndex = (qIndex-1+queue.length)%queue.length; play(qIndex); }
  function next(){ if(queue.length===0) return; qIndex = (qIndex+1)%queue.length; play(qIndex); }
  prevBtn.onclick=prev; nextBtn.onclick=next;
  window.addEventListener('keydown', function(e){ if(e.altKey && e.key==='ArrowLeft') prev(); if(e.altKey && e.key==='ArrowRight') next(); });

  function resolveLaneUrl(id){ var t=(manifest.tracks||[]).find(function(x){return x.id===id;}); return t? ujoin(manifestUrl, t.path) : null; }

  function selectInitial(itemsList){
    if(DAYQ && itemsList[DAYQ-1]) return itemsList[DAYQ-1];
    if(DATEQ){ var d=itemsList.find(function(x){return x.date===DATEQ}); if(d) return d; }
    return itemsList[0]||null;
  }

  function loadLane(){
    var url = resolveLaneUrl(laneId);
    if(!url){ items=[]; queue=[]; updateNow({}); return; }
    fetch(url,{cache:'no-store'}).then(function(r){return r.json()}).then(function(j){
      items = Array.isArray(j.items)? j.items.slice(0): [];
      var start = selectInitial(items);
      var startIdx = start ? items.findIndex(function(x){return x.date===start.date}) : 0;
      queue = items.slice(startIdx).concat(items.slice(0,startIdx));
      qIndex = 0;
      var id = (queue[0].urls && queue[0].urls.youtube)? extractYouTubeID(queue[0].urls.youtube) : '';
      updateNow(queue[0]); if(id) renderYouTube(id);
    });
  }

  fetch(manifestUrl,{cache:'no-store'}).then(function(r){return r.json()}).then(function(m){
    manifest=m||{tracks:[],dates:{start:'',end:'',days:42}};
    lanes=(manifest.tracks||[]).map(function(t){return {id:t.id,label:t.label||t.id};});
    if(!lanes.length){ lanes=[{id:'anchor-public',label:'AnchorPublic'}]; }
    if(!lanes.some(function(x){return x.id===laneId;})){ laneId=(lanes.find(function(x){return x.id==='anchor-public';})||lanes[0]).id; }
    plistEl.innerHTML = lanes.map(function(t){return '<option value="'+t.id+'">'+t.label+'</option>';}).join('');
    plistEl.value = laneId;
    plistEl.addEventListener('change', function(){
      var u=new URL(location.href); u.searchParams.set('playlist', this.value); location.href=u.toString();
    });
    loadLane();
  });
})();
</script>
</body>
</html>
