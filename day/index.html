<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Jar â€” Day</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina Day view: sticky player, playlists (Explainer / Anchor Â· Public / Anchor Â· Built), UTF fixes, and tâ€‘scale badge.">
<style>
  :root{--bg:#0B0F19;--ink:#E6EAF2;--muted:#94A3B8;--line:rgba(255,255,255,.12);--card:#0F1524;--hi:#A4E8FF;--gold:#F7C948;--ok:#34D399;--err:#F87171}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Inter,Roboto,Arial}
  a{color:#BBD7FF;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 72px}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0B0F19 70%,rgba(11,15,25,.8));border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(8px)}
  .head{display:grid;grid-template-columns:1fr 520px;gap:14px;align-items:center;padding:10px 16px}
  @media (max-width:980px){.head{grid-template-columns:1fr}}
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:13px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .ok{color:var(--ok);border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.12)}
  .warn{color:#FBBF24;border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.12)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .player{position:relative;aspect-ratio:16/9;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000}
  .player iframe{width:100%;height:100%;border:0}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .card h3{margin:0 0 6px;font-size:18px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:rgba(255,255,255,.02)}
  .big{font-size:28px;line-height:1.1;font-weight:800;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), var(--card);font-weight:700;cursor:pointer}
  .btn:hover{border-color:rgba(164,232,255,.35)}
  .footer{margin-top:18px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .select{appearance:none;background:var(--card);color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:6px 10px}
</style>
</head>
<body>
<header>
  <div class="head wrap">
    <div>
      <h1 id="dayTitle">Day â€”</h1>
      <div class="row">
        <span id="dateOut" class="pill">â€”</span>
        <span id="phaseOut" class="pill">â€”</span>
        <span id="tscale" class="pill">tâ€‘scale â€”</span>
        <label class="pill" title="Choose which playlist variant to view">
          Playlist:
          <select id="plist" class="select">
            <option value="explainer">Explainer</option>
            <option value="anchorPublic">Anchor Â· Public</option>
            <option value="anchorBuilt">Anchor Â· Built</option>
          </select>
        </label>
      </div>
      <div class="sub">Sticky player stays while you scroll â€¢ Autoplay next â€¢ Loads master 3â€‘inâ€‘1 JSON or legacy schema</div>
      <div class="row" style="margin-top:6px">
        <a class="btn" href="/timeline/illumina1/">ğŸ—ºï¸ 6â€‘Week Timeline</a>
        <a class="btn" href="/map/">âœ¨ Constellation Map</a>
        <a class="btn" href="https://tunes.plnt.earth" target="_blank" rel="noopener">ğŸ¶ Tunes</a>
      </div>
    </div>
    <div class="player" id="playerBox"></div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card" id="nowCard">
      <h3>Now Playing</h3>
      <div id="trackTitle" class="big">â€”</div>
      <div class="chips" style="margin-top:8px">
        <span id="artistChip" class="chip">Artist â€”</span>
        <span id="seedChip" class="chip">Seed â€”</span>
        <span id="figureChip" class="chip">Figure â€”</span>
        <span id="phaseChip" class="chip">Phase â€”</span>
      </div>
      <div class="mono" id="urlOut" style="margin-top:8px">â€”</div>
      <div class="row" style="margin-top:10px">
        <a class="btn" id="openInYT" target="_blank" rel="noopener">Open in YouTube</a>
      </div>
    </section>

    <aside class="card">
      <h3>Ritual</h3>
      <div id="ritualText" class="muted">â€”</div>
      <div class="chips" style="margin-top:10px">
        <span class="chip">ğŸ¯ Honey</span><span class="chip">ğŸ Bee</span><span class="chip">ğŸŒ™ Moon</span>
      </div>
      <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
      <h3>Notes</h3>
      <div id="notes" class="muted">â€”</div>
    </aside>
  </div>

  <section class="card" style="margin-top:14px">
    <h3>Queue</h3>
    <div id="queue" class="mono">â€”</div>
  </section>

  <div class="footer">
    <div>Â© <span id="yy"></span> PLNT.earth â€” Jar Day</div>
    <div><a href="/map/">Constellation</a> â€¢ <a href="https://time.plnt.earth" target="_blank" rel="noopener">Time</a> â€¢ <a href="https://zeta.plnt.earth" target="_blank" rel="noopener">Zeta</a></div>
  </div>
</div>

<script>
/* ===== URL & state ===== */
const QS = new URLSearchParams(location.search);
const DAYQ = parseInt(QS.get("day")||"0",10) || null;
const DATEQ = QS.get("date") || null; // supports ?date=YYYY-MM-DD
const PLAYLISTQ = (QS.get("playlist")||"explainer").toLowerCase();

/* ===== Elements ===== */
const yyEl = document.getElementById('yy'); yyEl.textContent = new Date().getFullYear();
const plistEl = document.getElementById('plist'); plistEl.value = PLAYLISTQ;
plistEl.addEventListener('change', () => {
  const u = new URL(location.href);
  u.searchParams.set('playlist', plistEl.value);
  location.href = u.toString();
});

/* ===== UTF / Name fixes ===== */
const NAME_FIX = new Map([
  ["beyonce","BeyoncÃ©"],["beyoncÃ©","BeyoncÃ©"],
  ["maneskin","MÃ¥neskin"],["mÃ¥neskin","MÃ¥neskin"],
  ["chloe","ChlÃ¶e"],["chloÃ«","ChloÃ«"],
  ["rosalia","RosalÃ­a"],["jose gonzalez","JosÃ© GonzÃ¡lez"]
]);
function fixName(raw){ if(!raw) return ""; const n=raw.normalize?raw.normalize('NFC'):raw; const k=n.trim().toLowerCase(); return NAME_FIX.get(k)||n; }
function fixMojibake(s){ if(typeof s!=="string") return s; return s.normalize('NFC').replace(/Beyonc\u00c3\u00a9/gi,'BeyoncÃ©').replace(/M\u00c3\u00a5neskin/gi,'MÃ¥neskin').replace(/\u2019/g,'â€™'); }
function deepFix(o){ if(Array.isArray(o)) return o.map(deepFix); if(o&&typeof o==='object'){const x={}; for(const k in o) x[k]=deepFix(o[k]); return x;} return fixMojibake(o); }

/* ===== Data sources ===== */
// Preferred master 3-in-1 file:
const MASTER_URL = "/Illumina1_Playlist_MASTER_3in1.json";
// Legacy fallback file (if you still keep it):
const LEGACY_URL = "/data/illumina1.json";

async function fetchJSON(url){ const r = await fetch(url,{cache:'no-store'}); if(!r.ok) throw new Error('fetch fail'); return deepFix(await r.json()); }

async function loadModel(){
  try{
    const master = await fetchJSON(MASTER_URL);
    if(master && Array.isArray(master.days)) return { type:'master', data: master };
  }catch(e){ /* fall through */ }
  // legacy
  const legacy = await fetchJSON(LEGACY_URL);
  return { type:'legacy', data: legacy };
}

/* ===== Render helpers ===== */
function safeURL(href){ try{ return new URL(href, 'https://youtube.com').href; }catch{ return ''; } }
function vidFromURL(href){ try{ const u=new URL(href, 'https://youtube.com'); return u.searchParams.get('v') || u.pathname.split('/').pop(); }catch{ return ''; } }

function selectDayFromLegacy(model){
  const days = model.Days||[];
  if (DAYQ!=null && days[DAYQ-1]) return days[DAYQ-1];
  if (DATEQ){ const d = days.find(x=>x.Date===DATEQ); if(d) return d; }
  return days[0]||null;
}

function selectDayFromMaster(master){
  const days = master.days||[];
  if (DAYQ!=null && days[DAYQ-1]) return days[DAYQ-1];
  if (DATEQ){ const d = days.find(x=>x.Date===DATEQ); if(d) return d; }
  return days[0]||null;
}

function itemForPlaylist(day, key){
  // key: explainer | anchorPublic | anchorBuilt
  const map = { explainer:'Explainer', anchorpublic:'AnchorPublic', anchorbuilt:'AnchorBuilt' };
  const field = map[key.toLowerCase()] || 'Explainer';
  return day ? day[field] : null;
}

/* ===== Time constants badge (optional) ===== */
async function loadTScale(dateStr){
  try{
    const r = await fetch('/data/time_constants.json',{cache:'no-store'});
    if(!r.ok) throw 0;
    const d = await r.json();
    const badge = document.getElementById('tscale');
    badge.textContent = `tâ€‘scale Î± ${(+(d.alpha||0)).toFixed(2)} Â· Î² ${(+(d.beta||0)).toFixed(2)}`;
    const s = (d.day_signals||[]).find(x=>x.date===dateStr);
    if(s){ const w = 0.5*((+s.tm_weight||0)+(+s.te_weight||0)); badge.textContent += ` Â· w ${w.toFixed(2)}`; badge.classList.add('ok'); }
  }catch{ document.getElementById('tscale').textContent = 'tâ€‘scale â€”'; }
}

/* ===== Player/autoplay state ===== */
let ytReady=false, player=null, queue=[];
function renderYouTube(videoId, listId){
  const box = document.getElementById('playerBox');
  const src = listId ? `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&enablejsapi=1&modestbranding=1&playsinline=1&list=${encodeURIComponent(listId)}`
                     : `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&enablejsapi=1&modestbranding=1&playsinline=1`;
  box.innerHTML = `<iframe id="yt" src="${src}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
  setupYTAPI();
}
function setupYTAPI(){ if(window.YT&&YT.Player) return initYT(); const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; document.head.appendChild(s); window.onYouTubeIframeAPIReady=initYT; }
function initYT(){ if(ytReady) return; ytReady=true; player=new YT.Player('yt',{ events:{ onStateChange: ev=>{ if(ev.data===0) playNext(); } } }); }
function playNext(){ if(queue.length>1){ queue.shift(); const nxt=queue[0]; if(player&&player.loadVideoById) player.loadVideoById(nxt.videoId); updateNow(nxt); renderQueue(); } }

/* ===== Update UI ===== */
function updateNow(day){
  // Day object may be legacy (flat) or master (needs playlist item parsing)
  let artist='â€”', title='â€”', url='';
  if(day.Track){
    // legacy flat
    const t=(day.Track||'').trim(); const p=t.split('â€“'); artist = fixName((p[0]||'').trim()); title = (p[1]||t).trim(); url = day.URL||'';
  } else {
    const it = itemForPlaylist(day, plistEl.value);
    if(it){ artist = fixName(it.artist||''); title = (it.title||'â€”').trim(); url = (it.Platforms&&it.Platforms.YouTube&&it.Platforms.YouTube.url)||''; }
  }
  document.getElementById('dayTitle').textContent = `Day ${day.Day||'â€”'}`;
  document.getElementById('dateOut').textContent = day.Date||'â€”';
  document.getElementById('phaseOut').textContent = day.MoonPhase||'â€”';
  document.getElementById('phaseChip').textContent = day.MoonPhase||'â€”';
  document.getElementById('trackTitle').textContent = `${artist?artist+" â€” ":''}${title}`;
  document.getElementById('artistChip').textContent = artist||'â€”';
  document.getElementById('seedChip').textContent = day.SeedRitual||'â€”';
  document.getElementById('figureChip').textContent = day.Figure||'â€”';
  document.getElementById('urlOut').textContent = url||'â€”';
  document.getElementById('openInYT').href = url? safeURL(url) : 'https://youtube.com';
  document.getElementById('ritualText').textContent = day.SeedRitual? `Tonight: ${day.SeedRitual}` : 'â€”';
  document.getElementById('notes').textContent = day.Notes||'';
}

function renderQueue(){
  const q = queue.map((d,i)=>{
    let artist='â€”', title='â€”';
    if(d.Track){ const t=(d.Track||'').trim(); const p=t.split('â€“'); artist=fixName((p[0]||'').trim()); title=(p[1]||t).trim(); }
    else {
      const it=itemForPlaylist(d, plistEl.value); if(it){ artist=fixName(it.artist||''); title=(it.title||'â€”').trim(); }
    }
    return `${i===0?"â–¶ ":"  "}${String(d.Day).padStart(2,'0')} Â· ${artist} â€” ${title}`;
  }).join('\n');
  document.getElementById('queue').textContent = q || 'â€”';
}

/* ===== Boot ===== */
(async ()=>{
  const {type, data} = await loadModel();
  let today=null, days=[]; let playlistId="";
  if(type==='master'){
    days = data.days||[]; today = selectDayFromMaster(data);
    // optional playlist IDs from meta
    const pmap = (data.meta&&data.meta.playlists)||{}; playlistId = pmap[plistEl.value]||"";
  } else {
    days = data.Days||[]; today = selectDayFromLegacy(data);
    playlistId = data.playlistId || "";
  }
  if(!today){ updateNow({}); renderQueue(); const b=document.getElementById('tscale'); b.classList.add('warn'); b.textContent='No day data'; return; }

  // Build queue from today onward; skip entries lacking a usable URL in master mode
  const startIdx = (days.findIndex(d=>d.Date===today.Date)>=0)? days.findIndex(d=>d.Date===today.Date):0;
  queue = days.slice(startIdx).filter(d=>{
    if(d.Track) return true; // legacy always include
    const it=itemForPlaylist(d, plistEl.value); const url=(it&&it.Platforms&&it.Platforms.YouTube&&it.Platforms.YouTube.url)||''; return !!url;
  }).map(d=>{
    let url='';
    if(d.Track){ url=d.URL||''; }
    else { const it=itemForPlaylist(d, plistEl.value); url=(it&&it.Platforms&&it.Platforms.YouTube&&it.Platforms.YouTube.url)||''; }
    return {...d, videoId: vidFromURL(url)};
  });

  updateNow(queue[0]);
  renderQueue();
  renderYouTube(queue[0].videoId, playlistId);
  loadTScale(today.Date);
})();
</script>
</body>
</html>
