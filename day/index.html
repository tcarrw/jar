<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>JAR Â· Day</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina Day view with player, figure, seed ritual, and notes.">
<style>
  :root{
    --bg:#0B0F19;--ink:#E5E7EB;--muted:#9CA3AF;--line:rgba(229,231,235,.15);
    --gold:#F5D142;--amber:#F59E0B;--ok:#34D399;--warn:#FBBF24;--err:#F87171;
    --r:14px;--pad:18px;--maxw:1100px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;background:var(--bg);color:var(--ink);
    font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;
    padding-top:260px; /* space for fixed header; JS nudges this */
  }
  a{color:var(--gold);text-decoration:none}
  a:hover{text-decoration:underline}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:clamp(14px,3.5vw,28px)}
  h1{margin:.2em 0 .2em;font-size:clamp(22px,4.6vw,34px);line-height:1.2}
  h2{margin:.6em 0 .2em;font-size:clamp(18px,3.4vw,22px)}
  p{margin:.4em 0 1em;color:#e6e9f1}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

  /* Cards & layout */
  .grid{display:grid;gap:12px}
  .cards{grid-template-columns:1fr}
  @media (min-width:860px){.cards{grid-template-columns:1.15fr .85fr}}
  .card{border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);
        background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0))}
  .row{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .tag{font-size:12px;color:#cfd3db;border:1px dashed var(--line);border-radius:8px;padding:2px 8px}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:13px}

  /* Buttons & inputs */
  .btn{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.02);color:var(--ink);cursor:pointer}
  .btn.primary{border-color:var(--amber);background:linear-gradient(180deg,rgba(245,209,66,.15),rgba(245,158,11,.12))}
  input[type="text"], textarea{
    width:100%;padding:10px 12px;border:1px solid var(--line);border-radius:12px;background:rgba(255,255,255,.02);color:var(--ink);font:inherit
  }
  textarea{min-height:120px}

  /* Fixed player header */
  .playerbar{position:fixed;left:0;right:0;top:0;z-index:9999;background:rgba(11,15,25,.96);backdrop-filter:saturate(120%) blur(10px);border-bottom:1px solid var(--line)}
  .playerwrap{max-width:var(--maxw);margin:0 auto;padding:8px 0 8px}
  .player-row{display:grid;gap:10px;grid-template-columns:1fr;align-items:center;padding:0 clamp(14px,3.5vw,28px)}
  @media (min-width:860px){.player-row{grid-template-columns:360px 1fr 220px}}
  .now{font-size:13px;color:var(--muted)} .now strong{color:#e9ecf3}
  .frame{position:relative;aspect-ratio:16/9;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:rgba(255,255,255,.03)}
  .frame #yt{position:absolute;inset:0}
  .controls{display:flex;gap:8px;justify-content:flex-end;align-items:center}
</style>
</head>
<body>
<!-- Fixed Player Header -->
<div class="playerbar" aria-label="Player">
  <div class="playerwrap">
    <div class="player-row">
      <div>
        <div class="now">Now Playing</div>
        <div id="nowTitle" class="mono" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">â€”</div>
        <div id="nowMeta" class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">â€”</div>
      </div>
      <div class="frame"><div id="yt"></div></div>
      <div class="controls">
        <button class="btn" id="prevBtn" type="button">âŸ¨ Prev</button>
        <button class="btn" id="nextBtn" type="button">Next âŸ©</button>
        <button class="btn primary" id="shareBtn" type="button">Share Day</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <header class="card">
    <div class="row">
      <span class="tag" id="dayTag">Day â€”</span>
      <span class="tag mono" id="dateTag">â€”</span>
      <span class="tag" id="phaseTag">â€”</span>
    </div>
    <h1 id="title">â€”</h1>
    <div class="muted" id="artist">â€”</div>
    <div class="row" style="gap:10px;margin-top:8px">
      <a class="btn" id="openTunes" target="_blank" rel="noopener">Open in Tunes</a>
      <button class="btn" id="copyTunes" type="button">Copy Tunes Link</button>
    </div>
  </header>

  <section class="grid cards">
    <div class="card">
      <h2>Figure</h2>
      <p id="figure">â€”</p>
      <h2>Seed Ritual</h2>
      <p id="seed">â€”</p>
    </div>

    <div class="card">
      <h2>Links</h2>
      <div class="row" style="gap:10px">
        <a class="btn" href="https://jar.plnt.earth/interludes/" target="_blank" rel="noopener">Interludes</a>
        <a class="btn" href="https://jar.plnt.earth/references/" target="_blank" rel="noopener">References</a>
        <a class="btn" href="https://jar.plnt.earth/science/" target="_blank" rel="noopener">Science</a>
        <a class="btn" href="https://jar.plnt.earth/archive/" target="_blank" rel="noopener">Archive</a>
      </div>
      <h2 style="margin-top:16px">Navigate</h2>
      <div class="row" style="gap:10px">
        <button class="btn" id="goPrev" type="button">âŸ¨ Previous Day</button>
        <button class="btn" id="goNext" type="button">Next Day âŸ©</button>
      </div>
    </div>
  </section>

  <section class="card" style="margin-top:12px">
    <h2>Moon Note (private)</h2>
    <p class="muted">Saved on your device only.</p>
    <textarea id="note" placeholder="Write your noteâ€¦"></textarea>
    <div class="row" style="gap:10px;margin-top:8px">
      <button class="btn primary" id="saveNote" type="button">Save Note</button>
      <button class="btn" id="clearNote" type="button">Clear</button>
    </div>
  </section>
</div>

<!-- YouTube Iframe API loader -->
<script>
  (function loadYT(){
    if (window.YT && YT.Player) return;
    var s = document.createElement('script'); s.src="https://www.youtube.com/iframe_api"; s.async=true;
    document.head.appendChild(s);
  })();
</script>

<script>
(function(){
  /* ===== Config ===== */
  var MASTER_JSON = '/Illumina1_Playlist_MASTER_3in1.json'; // update if needed
  var DEFAULT_LANE = 'Explainer'; // we show Explainer content on JAR

  /* ===== State ===== */
  var data = null, dayNum = null, dayIdx = null, laneRow = null;
  var player, playerReady=false, queuedId=null;

  /* ===== Elements ===== */
  var dayTag = document.getElementById('dayTag');
  var dateTag = document.getElementById('dateTag');
  var phaseTag = document.getElementById('phaseTag');
  var titleEl = document.getElementById('title');
  var artistEl = document.getElementById('artist');
  var figureEl = document.getElementById('figure');
  var seedEl = document.getElementById('seed');
  var openTunes = document.getElementById('openTunes');
  var copyTunes = document.getElementById('copyTunes');
  var prevBtn = document.getElementById('prevBtn');
  var nextBtn = document.getElementById('nextBtn');
  var goPrev = document.getElementById('goPrev');
  var goNext = document.getElementById('goNext');
  var shareBtn = document.getElementById('shareBtn');
  var noteEl = document.getElementById('note');
  var saveNote = document.getElementById('saveNote');
  var clearNote = document.getElementById('clearNote');
  var nowTitle = document.getElementById('nowTitle');
  var nowMeta = document.getElementById('nowMeta');

  function setBodyTop(){
    var bar = document.querySelector('.playerbar'); if(!bar) return;
    var h = bar.getBoundingClientRect().height;
    document.body.style.paddingTop = Math.ceil(h+8) + 'px';
  }
  window.addEventListener('resize', setBodyTop, {passive:true});
  window.addEventListener('orientationchange', setBodyTop, {passive:true});
  setTimeout(setBodyTop, 60);

  function safe(v){ return v==null ? "" : String(v); }

  function moonEmoji(dateStr){
    if(!dateStr) return 'â€”';
    var d = new Date(dateStr+'T00:00:00Z'), syn=29.53058867, base=Date.UTC(2025,0,29);
    var days=(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())-base)/86400000;
    var phase=((days%syn)+syn)%syn;
    return ['ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜'][Math.floor((phase/syn)*8+0.5)%8];
  }

  function extractYouTubeID(u){
    if(!u) return "";
    var s=String(u);
    var m = s.match(/[?&]v=([^&]+)/) || s.match(/youtu\.be\/([^?&]+)/) || s.match(/embed\/([^?&]+)/);
    return m ? m[1] : "";
  }

  function queryDay(){
    var q = new URLSearchParams(location.search);
    var d = q.get('day'), dt = q.get('date');
    if(d){ return {by:'day', val:Math.max(1, Math.min(42, parseInt(d,10)||1))}; }
    if(dt){ return {by:'date', val:dt}; }
    return {by:'day', val:1};
  }

  function findDayIdx(meta){
    if(!data || !data.PerDay) return 0;
    if(meta.by==='day'){
      var idx = (meta.val-1)|0;
      return Math.max(0, Math.min(idx, data.PerDay.length-1));
    } else {
      var i = data.PerDay.findIndex(x=>safe(x.Date)===safe(meta.val));
      return i<0?0:i;
    }
  }

  function setNow(day){
    var base = data.PerDay[day-1] || {};
    var row = base[DEFAULT_LANE] || {};
    nowTitle.textContent = safe(row.title||'â€”');
    nowMeta.textContent  = safe(row.artist||'â€”') + ' Â· Day '+day+' Â· '+safe(base.Date||'')+' Â· '+moonEmoji(base.Date||'');
  }

  function renderDay(){
    var base = data.PerDay[dayIdx] || {};
    dayNum = base.Day || (dayIdx+1);
    laneRow = base[DEFAULT_LANE] || {};

    dayTag.textContent = 'Day '+dayNum;
    dateTag.textContent = safe(base.Date||'â€”');
    phaseTag.textContent = moonEmoji(base.Date||'');
    titleEl.textContent = safe(laneRow.title||'â€”');
    artistEl.textContent = safe(laneRow.artist||'â€”');
    figureEl.textContent = safe(base.Figure||'â€”');
    seedEl.textContent = safe(base.SeedRitual||'â€”');

    // Tunes link (deep link to this day in Explainer)
    var tunes = new URL('https://tunes.plnt.earth/');
    tunes.searchParams.set('lane', DEFAULT_LANE);
    tunes.searchParams.set('day', dayNum);
    openTunes.href = tunes.toString();

    copyTunes.onclick = function(){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(tunes.toString());
        copyTunes.textContent='Copied!'; setTimeout(()=>copyTunes.textContent='Copy Tunes Link',900);
      }
    };

    // Share this JAR day
    shareBtn.onclick = function(){
      var u = new URL(location.href);
      u.searchParams.set('day', dayNum);
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(u.toString());
        shareBtn.textContent='Copied!'; setTimeout(()=>shareBtn.textContent='Share Day',900);
      }
    };

    // Notes (local)
    var key = 'jar_note_'+(base.Date||('day_'+dayNum));
    noteEl.value = localStorage.getItem(key) || '';
    saveNote.onclick = function(){ localStorage.setItem(key, noteEl.value||'');};
    clearNote.onclick = function(){ noteEl.value=''; localStorage.removeItem(key);};

    // Prev/Next navigation
    goPrev.onclick = prevDay; prevBtn.onclick = prevDay;
    goNext.onclick = nextDay; nextBtn.onclick = nextDay;

    // Play the day's video if player ready or queue if not
    var id = extractYouTubeID(safe((laneRow.Platforms&&laneRow.Platforms.YouTube&&laneRow.Platforms.YouTube.url)||''));
    if(id){
      if(playerReady){ player.loadVideoById(id); }
      else { queuedId = id; }
      setNow(dayNum);
    }
    // scroll to top content area (under fixed bar)
    window.scrollTo({top:0,behavior:'smooth'});
  }

  function prevDay(){
    dayIdx = Math.max(0, dayIdx-1);
    renderDay();
  }
  function nextDay(){
    dayIdx = Math.min((data.PerDay.length-1), dayIdx+1);
    renderDay();
  }

  function load(){
    fetch(MASTER_JSON, {cache:'no-store'})
      .then(r=>r.json())
      .then(json=>{
        data = json;
        dayIdx = findDayIdx(queryDay());
        renderDay();
      })
      .catch(()=>{ titleEl.textContent='Load error'; });
  }

  // YouTube API callback
  window.onYouTubeIframeAPIReady = function(){
    player = new YT.Player('yt', {
      width:'100%', height:'100%', playerVars:{rel:0,modestbranding:1,playsinline:1},
      events:{
        onReady:function(){
          playerReady=true;
          if(queuedId){ player.loadVideoById(queuedId); queuedId=null; }
        },
        onStateChange:function(e){
          // Auto-advance on end
          if(e.data===YT.PlayerState.ENDED){ nextDay(); }
        }
      }
    });
  };

  load();
})();
</script>
</body>
</html>
