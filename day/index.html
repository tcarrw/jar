<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Jar ‚Äî Day</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina Day: sticky player, queue with next/prev controls, playlist switcher, UTF fixes, t‚Äëscale badge, and optional per‚Äëtrack daily tasks/rituals.">
<style>
  :root{--bg:#0B0F19;--ink:#E6EAF2;--muted:#94A3B8;--line:rgba(255,255,255,.12);--card:#0F1524;--hi:#A4E8FF;--gold:#F7C948;--ok:#34D399;--err:#F87171}
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Inter,Roboto,Arial}
  a{color:#BBD7FF;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 84px}
  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0B0F19 70%,rgba(11,15,25,.85));border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(8px)}
  .head{display:grid;grid-template-columns:1fr 520px;gap:14px;align-items:center;padding:10px 16px}
  @media (max-width:980px){.head{grid-template-columns:1fr}}
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:13px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .ok{color:var(--ok);border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.12)}
  .warn{color:#FBBF24;border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.12)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .player{position:relative;aspect-ratio:16/9;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000}
  .player iframe{width:100%;height:100%;border:0}
  .controls{display:flex;gap:8px;align-items:center;margin-top:8px}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), var(--card);font-weight:700;cursor:pointer}
  .btn:hover{border-color:rgba(164,232,255,.35)}
  .select{appearance:none;background:var(--card);color:var(--ink);border:1px solid var(--line);border-radius:10px;padding:6px 10px}
  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:16px}
  @media (max-width:980px){.grid{grid-template-columns:1fr}}
  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), var(--card);border:1px solid var(--line);border-radius:14px;padding:14px}
  .card h3{margin:0 0 6px;font-size:18px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:rgba(255,255,255,.02)}
  .big{font-size:28px;line-height:1.1;font-weight:800;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .footer{margin-top:18px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
  .queue{white-space:pre-wrap}
</style>
</head>
<body>
<header>
  <div class="head wrap">
    <div>
      <h1 id="dayTitle">Day ‚Äî</h1>
      <div class="row">
        <span id="dateOut" class="pill">‚Äî</span>
        <span id="phaseOut" class="pill">‚Äî</span>
        <span id="tscale" class="pill">t‚Äëscale ‚Äî</span>
        <label class="pill" title="Choose which playlist variant to view">
          Playlist:
          <select id="plist" class="select">
            <option value="explainer">Explainer</option>
            <option value="anchorPublic">Anchor ¬∑ Public</option>
            <option value="anchorBuilt">Anchor ¬∑ Built</option>
          </select>
        </label>
        <label class="pill" title="Loop the queue">
          <input id="loop" type="checkbox" style="accent-color:#5eead4"> Loop
        </label>
      </div>
      <div class="sub">Sticky player ‚Ä¢ Autoplay next ‚Ä¢ Next/Prev controls ‚Ä¢ Reads master 3‚Äëin‚Äë1 JSON or legacy schema</div>
      <div class="controls">
        <button id="prevBtn" class="btn" title="Previous in queue (‚å•‚Üê)">‚üµ Prev</button>
        <button id="nextBtn" class="btn" title="Next in queue (‚å•‚Üí)">Next ‚ü∂</button>
        <a class="btn" href="/timeline/illumina1/">üó∫Ô∏è Timeline</a>
        <a class="btn" href="/map/">‚ú® Map</a>
        <a class="btn" href="https://tunes.plnt.earth" target="_blank" rel="noopener">üé∂ Tunes</a>
      </div>
    </div>
    <div class="player" id="playerBox"></div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card" id="nowCard">
      <h3>Now Playing</h3>
      <div id="trackTitle" class="big">‚Äî</div>
      <div class="chips" style="margin-top:8px">
        <span id="artistChip" class="chip">Artist ‚Äî</span>
        <span id="seedChip" class="chip">Seed ‚Äî</span>
        <span id="figureChip" class="chip">Figure ‚Äî</span>
        <span id="phaseChip" class="chip">Phase ‚Äî</span>
      </div>
      <div class="mono" id="urlOut" style="margin-top:8px">‚Äî</div>
      <div class="row" style="margin-top:10px">
        <a class="btn" id="openInYT" target="_blank" rel="noopener">Open in YouTube</a>
      </div>
    </section>

    <aside class="card">
      <h3>Daily Task / Ritual</h3>
      <div id="taskText" class="muted">‚Äî</div>
      <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
      <h3>Notes</h3>
      <div id="notes" class="muted">‚Äî</div>
    </aside>
  </div>

  <section class="card" style="margin-top:14px">
    <h3>Queue</h3>
    <div id="queue" class="mono queue">‚Äî</div>
  </section>

  <div class="footer">
    <div>¬© <span id="yy"></span> PLNT.earth ‚Äî Jar Day</div>
    <div><a href="/map/">Constellation</a> ‚Ä¢ <a href="https://time.plnt.earth" target="_blank" rel="noopener">Time</a> ‚Ä¢ <a href="https://zeta.plnt.earth" target="_blank" rel="noopener">Zeta</a></div>
  </div>
</div>

<script>
/* ===== URL & state ===== */
const QS = new URLSearchParams(location.search);
const DAYQ = parseInt(QS.get("day")||"0",10) || null;
const DATEQ = QS.get("date") || null;
const PLAYLISTQ = (QS.get("playlist")||"explainer").toLowerCase();

/* ===== Elements ===== */
const yyEl = document.getElementById('yy'); yyEl.textContent = new Date().getFullYear();
const plistEl = document.getElementById('plist'); plistEl.value = PLAYLISTQ;
const loopEl  = document.getElementById('loop');
const prevBtn = document.getElementById('prevBtn');
const nextBtn = document.getElementById('nextBtn');
plistEl.addEventListener('change', () => { const u=new URL(location.href); u.searchParams.set('playlist', plistEl.value); location.href=u.toString(); });

/* ===== UTF fixes ===== */
const NAME_FIX = new Map([["beyonce","Beyonc√©"],["beyonc√©","Beyonc√©"],["maneskin","M√•neskin"],["m√•neskin","M√•neskin"],["chloe","Chl√∂e"],["chlo√´","Chlo√´"],["rosalia","Rosal√≠a"],["jose gonzalez","Jos√© Gonz√°lez"]]);
function fixName(raw){ if(!raw) return ""; const n=raw.normalize?raw.normalize('NFC'):raw; const k=n.trim().toLowerCase(); return NAME_FIX.get(k)||n; }
function fixMojibake(s){ if(typeof s!=="string") return s; return s.normalize('NFC').replace(/Beyonc\u00c3\u00a9/gi,'Beyonc√©').replace(/M\u00c3\u00a5neskin/gi,'M√•neskin').replace(/\u2019/g,'‚Äô'); }
function deepFix(o){ if(Array.isArray(o)) return o.map(deepFix); if(o&&typeof o==='object'){const x={}; for(const k in o) x[k]=deepFix(o[k]); return x;} return fixMojibake(o); }

/* ===== Data sources ===== */
const MASTER_URL = "/Illumina1_Playlist_MASTER_3in1.json"; // preferred
const LEGACY_URL = "/data/illumina1.json";                  // fallback
const TASKS_URL  = "/data/illumina1_tasks.json";            // optional per‚Äëtrack tasks/rituals

async function fetchJSON(url){ const r=await fetch(url,{cache:'no-store'}); if(!r.ok) throw 0; return deepFix(await r.json()); }
async function loadModel(){
  try{ const m = await fetchJSON(MASTER_URL); if(m && Array.isArray(m.days)) return { type:'master', data:m }; }catch{}
  const l = await fetchJSON(LEGACY_URL); return { type:'legacy', data:l };
}
let TASKS=null;
(async()=>{ try{ TASKS = await fetchJSON(TASKS_URL); }catch{ TASKS=null; } })();

/* ===== Helpers ===== */
function safeURL(h){ try{ return new URL(h,'https://youtube.com').href; }catch{ return ''; } }
function vidFromURL(h){ try{ const u=new URL(h,'https://youtube.com'); return u.searchParams.get('v')||u.pathname.split('/').pop(); }catch{ return ''; } }
function selectDay(days){ if(DAYQ!=null && days[DAYQ-1]) return days[DAYQ-1]; if(DATEQ){ const d=days.find(x=>x.Date===DATEQ); if(d) return d; } return days[0]||null; }
function itemForPlaylist(day,key){ const map={explainer:'Explainer', anchorpublic:'AnchorPublic', anchorbuilt:'AnchorBuilt'}; return day ? day[map[key]||'Explainer'] : null; }

/* ===== Time constants badge ===== */
async function loadTScale(dateStr){ try{ const r=await fetch('/data/time_constants.json',{cache:'no-store'}); if(!r.ok) throw 0; const d=await r.json(); const b=document.getElementById('tscale'); b.textContent=`t‚Äëscale Œ± ${(+(d.alpha||0)).toFixed(2)} ¬∑ Œ≤ ${(+(d.beta||0)).toFixed(2)}`; const s=(d.day_signals||[]).find(x=>x.date===dateStr); if(s){ const w=0.5*((+s.tm_weight||0)+(+s.te_weight||0)); b.textContent+=` ¬∑ w ${w.toFixed(2)}`; b.classList.add('ok'); } }catch{ document.getElementById('tscale').textContent='t‚Äëscale ‚Äî'; } }

/* ===== Player & queue ===== */
let ytReady=false, player=null, queue=[], qIndex=0, playlistId="";
function renderYouTube(videoId){ const box=document.getElementById('playerBox'); const src=`https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&enablejsapi=1&modestbranding=1&playsinline=1`; box.innerHTML=`<iframe id="yt" src="${src}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`; setupYTAPI(); }
function setupYTAPI(){ if(window.YT&&YT.Player) return initYT(); const s=document.createElement('script'); s.src='https://www.youtube.com/iframe_api'; document.head.appendChild(s); window.onYouTubeIframeAPIReady=initYT; }
function initYT(){ if(ytReady) return; ytReady=true; player=new YT.Player('yt',{ events:{ onStateChange: ev=>{ if(ev.data===0) next(); } } }); }

function prev(){ if(queue.length===0) return; qIndex = (qIndex-1<0 ? (loopEl.checked? queue.length-1 : 0) : qIndex-1); playIndex(qIndex); }
function next(){ if(queue.length===0) return; qIndex = (qIndex+1>=queue.length ? (loopEl.checked? 0 : queue.length-1) : qIndex+1); playIndex(qIndex); }
prevBtn.onclick=prev; nextBtn.onclick=next;
window.addEventListener('keydown', e=>{ if(e.altKey && (e.key==='ArrowLeft')) prev(); if(e.altKey && (e.key==='ArrowRight')) next(); });

function playIndex(i){ const d=queue[i]; if(!d) return; if(player&&player.loadVideoById) player.loadVideoById(d.videoId); else renderYouTube(d.videoId); updateNow(d); renderQueue(); }

/* ===== UI Update ===== */
function updateNow(day){
  let artist='‚Äî', title='‚Äî', url='';
  if(day.Track){ const t=(day.Track||'').trim(); const p=t.split('‚Äì'); artist=fixName((p[0]||'').trim()); title=(p[1]||t).trim(); url=day.URL||''; }
  else { const it=itemForPlaylist(day, plistEl.value); if(it){ artist=fixName(it.artist||''); title=(it.title||'‚Äî').trim(); url=(it.Platforms&&it.Platforms.YouTube&&it.Platforms.YouTube.url)||''; } }
  document.getElementById('dayTitle').textContent=`Day ${day.Day||'‚Äî'}`;
  document.getElementById('dateOut').textContent=day.Date||'‚Äî';
  document.getElementById('phaseOut').textContent=day.MoonPhase||'‚Äî';
  document.getElementById('phaseChip').textContent=day.MoonPhase||'‚Äî';
  document.getElementById('trackTitle').textContent=`${artist?artist+' ‚Äî ':''}${title}`;
  document.getElementById('artistChip').textContent=artist||'‚Äî';
  document.getElementById('seedChip').textContent=day.SeedRitual||'‚Äî';
  document.getElementById('figureChip').textContent=day.Figure||'‚Äî';
  document.getElementById('urlOut').textContent=url||'‚Äî';
  document.getElementById('openInYT').href=url? safeURL(url) : 'https://youtube.com';
  document.getElementById('notes').textContent=day.Notes||'';

  // Task/Ritual resolution priority:
  // 1) day.Rituals[playlistKey] (per‚Äëplaylist task)
  // 2) day.Tasks[playlistKey]
  // 3) day.Ritual (generic) or day.SeedRitual
  // 4) external TASKS file: TASKS[date]?.[playlistKey] or TASKS[date]?.core
  let task='';
  const k=plistEl.value; // explainer/anchorPublic/anchorBuilt
  if(day.Rituals && (day.Rituals[k]||day.Rituals.core)) task = day.Rituals[k]||day.Rituals.core;
  else if(day.Tasks && (day.Tasks[k]||day.Tasks.core)) task = day.Tasks[k]||day.Tasks.core;
  else if(day.Ritual) task = day.Ritual;
  else if(day.SeedRitual) task = day.SeedRitual;
  else if(TASKS && TASKS[day.Date] && (TASKS[day.Date][k]||TASKS[day.Date].core)) task = TASKS[day.Date][k]||TASKS[day.Date].core;
  document.getElementById('taskText').textContent = task || '‚Äî';
}

function renderQueue(){ const q = queue.map((d,i)=>{ let artist='‚Äî', title='‚Äî'; if(d.Track){ const t=(d.Track||'').trim(); const p=t.split('‚Äì'); artist=fixName((p[0]||'').trim()); title=(p[1]||t).trim(); } else { const it=itemForPlaylist(d, plistEl.value); if(it){ artist=fixName(it.artist||''); title=(it.title||'‚Äî').trim(); } } return `${i===qIndex?"‚ñ∂ ":"  "}${String(d.Day).padStart(2,'0')} ¬∑ ${artist} ‚Äî ${title}`; }).join('\n'); document.getElementById('queue').textContent = q || '‚Äî'; }

/* ===== Boot ===== */
(async ()=>{
  const {type, data} = await loadModel();
  const days = type==='master' ? (data.days||[]) : (data.Days||[]);
  const today = selectDay(days);
  if(!today){ updateNow({}); renderQueue(); const b=document.getElementById('tscale'); b.classList.add('warn'); b.textContent='No day data'; return; }

  // Build queue from today onward; in master mode, skip items without YouTube URL for selected playlist
  const startIdx = (days.findIndex(d=>d.Date===today.Date)>=0)? days.findIndex(d=>d.Date===today.Date):0;
  queue = days.slice(startIdx).filter(d=>{ if(d.Track) return true; const it=itemForPlaylist(d, plistEl.value); const url=(it&&it.Platforms&&it.Platforms.YouTube&&it.Platforms.YouTube.url)||''; return !!url; }).map(d=>{ let url=''; if(d.Track){ url=d.URL||''; } else { const it=itemForPlaylist(d, plistEl.value); url=(it&&it.Platforms&&it.Platforms.YouTube&&it.Platforms.YouTube.url)||''; } return {...d, videoId: vidFromURL(url)}; });

  qIndex = 0;
  updateNow(queue[qIndex]);
  renderQueue();
  renderYouTube(queue[qIndex].videoId);
  loadTScale(today.Date);
})();
</script>
</body>
</html>
