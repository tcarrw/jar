<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Jar ‚Äî Day</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina Day view: sticky player, seed, notes, and t-scale badge.">
<style>
  :root{
    --bg:#0B0F19; --ink:#E6EAF2; --muted:#94A3B8; --line:rgba(255,255,255,.12);
    --card:#0F1524; --hi:#A4E8FF; --gold:#F7C948; --ok:#34D399; --err:#F87171;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);
       font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Inter,Roboto,Arial}
  a{color:#BBD7FF;text-decoration:none}
  .wrap{max-width:1100px;margin:0 auto;padding:16px 16px 72px}

  header{position:sticky;top:0;z-index:50;background:linear-gradient(180deg,#0B0F19 70%,rgba(11,15,25,.8));
         border-bottom:1px solid var(--line);backdrop-filter:saturate(140%) blur(8px)}
  .head{display:grid;grid-template-columns:1fr 520px;gap:14px;align-items:center;padding:10px 16px}
  @media (max-width:980px){ .head{grid-template-columns:1fr} }
  h1{margin:0;font-size:22px}
  .sub{color:var(--muted);font-size:13px}
  .pill{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;border:1px solid var(--line);font-size:12px}
  .ok{color:var(--ok);border-color:rgba(52,211,153,.35);background:rgba(52,211,153,.12)}
  .warn{color:#FBBF24;border-color:rgba(251,191,36,.35);background:rgba(251,191,36,.12)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}

  .player{position:relative;aspect-ratio:16/9;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:#000}
  .player iframe{width:100%;height:100%;border:0}

  .grid{display:grid;grid-template-columns:1.2fr .8fr;gap:14px;margin-top:16px}
  @media (max-width:980px){ .grid{grid-template-columns:1fr} }

  .card{background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), var(--card);
        border:1px solid var(--line);border-radius:14px;padding:14px}
  .card h3{margin:0 0 6px;font-size:18px}
  .mono{font-family:ui-monospace,Menlo,Consolas,monospace;font-size:12.5px;color:var(--muted)}
  .chips{display:flex;flex-wrap:wrap;gap:8px}
  .chip{border:1px solid var(--line);border-radius:999px;padding:6px 10px;font-size:12px;background:rgba(255,255,255,.02)}
  .big{font-size:28px;line-height:1.1;font-weight:800;letter-spacing:.2px}
  .muted{color:var(--muted)}
  .btn{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:12px;border:1px solid var(--line);
       background:linear-gradient(180deg, rgba(255,255,255,.02), transparent 40%), var(--card);
       font-weight:700;cursor:pointer}
  .btn:hover{border-color:rgba(164,232,255,.35)}
  .footer{margin-top:18px;color:var(--muted);font-size:13px;display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap}
</style>
</head>
<body>
<header>
  <div class="head wrap">
    <div>
      <h1 id="dayTitle">Day ‚Äî</h1>
      <div class="row">
        <span id="dateOut" class="pill">‚Äî</span>
        <span id="phaseOut" class="pill">‚Äî</span>
        <span id="tscale" class="pill">t-scale ‚Äî</span>
      </div>
      <div class="sub">Sticky player stays while you scroll ‚Ä¢ Autoplay next enabled</div>
    </div>
    <div class="player" id="playerBox">
      <!-- YouTube embed injected here -->
    </div>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <section class="card" id="nowCard">
      <h3>Now Playing</h3>
      <div id="trackTitle" class="big">‚Äî</div>
      <div class="chips" style="margin-top:8px">
        <span id="artistChip" class="chip">Artist ‚Äî</span>
        <span id="seedChip" class="chip">Seed ‚Äî</span>
        <span id="figureChip" class="chip">Figure ‚Äî</span>
        <span id="phaseChip" class="chip">Phase ‚Äî</span>
      </div>
      <div class="mono" id="urlOut" style="margin-top:8px">‚Äî</div>
      <div class="row" style="margin-top:10px">
        <a class="btn" id="openInYT" target="_blank" rel="noopener">Open in YouTube</a>
        <a class="btn" href="/map/">‚ú® Constellation Map</a>
        <a class="btn" href="/calendar/illumina1/">üóìÔ∏è Calendar</a>
      </div>
    </section>

    <aside class="card">
      <h3>Ritual</h3>
      <div id="ritualText" class="muted">‚Äî</div>
      <div class="chips" style="margin-top:10px">
        <span class="chip">üçØ Honey</span><span class="chip">üêù Bee</span><span class="chip">üåô Moon</span>
      </div>
      <hr style="border:none;border-top:1px solid var(--line);margin:12px 0">
      <h3>Notes</h3>
      <div id="notes" class="muted">‚Äî</div>
    </aside>
  </div>

  <section class="card" style="margin-top:14px">
    <h3>Queue</h3>
    <div id="queue" class="mono">‚Äî</div>
  </section>

  <div class="footer">
    <div>¬© <span id="yy"></span> PLNT.earth ‚Äî Jar Day</div>
    <div><a href="/map/">Constellation</a> ‚Ä¢ <a href="https://tunes.plnt.earth" target="_blank" rel="noopener">Tunes</a> ‚Ä¢ <a href="https://time.plnt.earth" target="_blank" rel="noopener">Time</a></div>
  </div>
</div>

<script>
/* ============ Utilities ============ */
const QS = new URLSearchParams(location.search);
const DAY = parseInt(QS.get("day")||"0",10) || null;
const DATE = QS.get("date") || null; // supports either ?day=N or ?date=YYYY-MM-DD

document.getElementById("yy").textContent = new Date().getFullYear();

/* Normalizer for artist names (handles ASCII fallbacks & NFC) */
const NAME_FIX = new Map([
  ["beyonce","Beyonc√©"],["beyonc√©","Beyonc√©"],
  ["maneskin","M√•neskin"],["m√•neskin","M√•neskin"],["maneskƒ±n","M√•neskin"],
  ["chloe","Chl√∂e"],["chlo√´","Chlo√´"],
  ["rosalia","Rosal√≠a"],["jose gonzalez","Jos√© Gonz√°lez"],
  ["asap rocky","A$AP Rocky"],["dua lipa","Dua Lipa"]
]);
function fixName(raw){
  if(!raw) return "";
  const nfc = raw.normalize ? raw.normalize("NFC") : raw;
  const key = nfc.trim().toLowerCase();
  return NAME_FIX.get(key) || nfc;
}

/* Safe join (prevents /jar/jar/ nesting mistakes) */
function cleanHref(href){ try{ return new URL(href, location.origin).href; } catch(_){ return href; } }

/* ============ Data source ============ 
   Priority:
   1) /data/illumina1.json (authoritative)
   2) Fallback= minimal object with YouTube playlist if JSON missing
*/
const DATA_URL = "/data/illumina1.json"; // your canonical 42-day list

async function loadData(){
  try{
    const r = await fetch(DATA_URL,{cache:"no-store"});
    if(!r.ok) throw new Error("not ok");
    return await r.json();
  }catch(e){
    // Fallback skeleton (set your playlist id if needed)
    return { playlistId:"PLXXXXXXXXXXXX", Days:[] };
  }
}

/* Find day by ?day or ?date */
function selectDay(model){
  if (DAY != null && model.Days && model.Days[DAY-1]) return model.Days[DAY-1];
  if (DATE){
    const d = (model.Days||[]).find(x => x.Date === DATE);
    if (d) return d;
  }
  // default to first defined day
  return (model.Days||[])[0] || null;
}

/* ============ Time constants badge (optional) ============ */
async function loadTScale(dateStr){
  try{
    const r = await fetch("/data/time_constants.json",{cache:"no-store"});
    if(!r.ok) throw new Error();
    const d = await r.json();
    document.getElementById("tscale").textContent = `t-scale Œ± ${(+d.alpha).toFixed(2)} ¬∑ Œ≤ ${(+d.beta).toFixed(2)}`;
    // if you also store per-day weights:
    const s = (d.day_signals||[]).find(x=>x.date===dateStr);
    if (s){
      const w = 0.5*((+s.tm_weight||0)+(+s.te_weight||0));
      document.getElementById("tscale").textContent += ` ¬∑ w ${w.toFixed(2)}`;
      document.getElementById("tscale").classList.add("ok");
    }
  }catch(_){
    document.getElementById("tscale").textContent = "t-scale ‚Äî";
  }
}

/* ============ Player & autoplay-next ============ */
let ytReady = false, player = null, queue = [];

function renderYouTube(videoId, listId){
  const box = document.getElementById("playerBox");
  const src = listId
    ? `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&enablejsapi=1&modestbranding=1&playsinline=1&list=${encodeURIComponent(listId)}`
    : `https://www.youtube.com/embed/${videoId}?autoplay=1&rel=0&enablejsapi=1&modestbranding=1&playsinline=1`;
  box.innerHTML = `<iframe id="yt" src="${src}" allow="autoplay; encrypted-media; picture-in-picture" allowfullscreen></iframe>`;
  setupYTAPI();
}

function setupYTAPI(){
  if (window.YT && YT.Player) return initYT();
  const s = document.createElement("script");
  s.src = "https://www.youtube.com/iframe_api";
  document.head.appendChild(s);
  window.onYouTubeIframeAPIReady = initYT;
}

function initYT(){
  if (ytReady) return;
  ytReady = true;
  player = new YT.Player("yt", {
    events: {
      'onStateChange': ev => {
        // 0 = ended, 1 = playing, 2 = paused
        if (ev.data === 0) playNext();
      }
    }
  });
}

function playNext(){
  // If we embedded with a playlist, YT will auto-advance.
  // If not, we manually load the next video from our queue.
  if (queue.length > 1){
    queue.shift();
    const nxt = queue[0];
    if (player && player.loadVideoById) player.loadVideoById(nxt.videoId);
    updateNow(nxt);
    renderQueue();
  }
}

/* ============ Render helpers ============ */
function updateNow(day){
  const title = (day.Track || "").trim();
  const parts = title.split("‚Äì");
  const left = parts[0] ? parts[0].trim() : "";
  const right = parts[1] ? parts[1].trim() : "";
  const artist = fixName(left);
  const song = right || title;

  document.getElementById("dayTitle").textContent = `Day ${day.Day || "‚Äî"}`;
  document.getElementById("dateOut").textContent = day.Date || "‚Äî";
  document.getElementById("phaseOut").textContent = day.MoonPhase || "‚Äî";
  document.getElementById("phaseChip").textContent = day.MoonPhase || "‚Äî";
  document.getElementById("trackTitle").textContent = song;
  document.getElementById("artistChip").textContent = artist || "‚Äî";
  document.getElementById("seedChip").textContent = day.SeedRitual || "‚Äî";
  document.getElementById("figureChip").textContent = day.Figure || "‚Äî";
  document.getElementById("urlOut").textContent = day.URL || "‚Äî";
  document.getElementById("openInYT").href = cleanHref(day.URL || "https://youtube.com");
  document.getElementById("ritualText").textContent = day.SeedRitual ? `Tonight: ${day.SeedRitual}` : "‚Äî";
  document.getElementById("notes").textContent = day.Notes || "";
}

function renderQueue(){
  const q = queue.map((d,i)=>{
    const t=(d.Track||"").trim();
    const parts=t.split("‚Äì");
    const artist=fixName(parts[0]?parts[0].trim():"");
    const song=parts[1]?parts[1].trim():t;
    return `${i===0?"‚ñ∂ ":"  "}${String(d.Day).padStart(2,"0")} ¬∑ ${artist} ‚Äî ${song}`;
  }).join("\n");
  document.getElementById("queue").textContent = q || "‚Äî";
}

/* ============ Boot ============ */
(async ()=>{
  const model = await loadData();
  // If you use a YouTube playlist, put its ID in model.playlistId
  const today = selectDay(model);
  if (!today){
    updateNow({}); renderQueue();
    document.getElementById("tscale").classList.add("warn");
    document.getElementById("tscale").textContent = "No day data";
    return;
  }

  // Build queue = today + the rest (simple roll-forward)
  const idx = (model.Days||[]).findIndex(d => d.Date===today.Date) || 0;
  queue = (model.Days||[]).slice(idx).map(d => {
    // naive videoId extraction from YouTube URL
    const u = new URL(d.URL||"", "https://youtube.com");
    const vid = u.searchParams.get("v") || u.pathname.split("/").pop();
    return {...d, videoId: vid};
  });

  updateNow(queue[0]);
  renderQueue();
  renderYouTube(queue[0].videoId, model.playlistId || "");

  // t-scale badge (optional JSON)
  loadTScale(today.Date);
})();
</script>
</body>
</html>
