<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Illumina 1 · Calendar</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina 1 — 42-day calendar with dates, moon phases, and day links.">
<style>
  :root{
    --bg:#0B0F19;--ink:#E5E7EB;--muted:#9CA3AF;--line:rgba(229,231,235,.14);
    --gold:#F5D142;--amber:#F59E0B;--ok:#34D399;--warn:#FBBF24;--err:#F87171;
    --r:16px;--pad:20px;--maxw:1200px;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.6 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--gold);text-decoration:none}
  a:hover{text-decoration:underline}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:clamp(14px,3.5vw,28px)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{border:1px solid var(--line);border-radius:999px;padding:9px 14px;background:rgba(255,255,255,.02);color:var(--ink);cursor:pointer}
  .btn.primary{border-color:var(--amber);background:linear-gradient(180deg,rgba(245,209,66,.16),rgba(245,158,11,.12))}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:13px}
  input[type="text"], select{
    padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.02);color:var(--ink);font:inherit
  }
  h1{margin:.2em 0 .2em;font-size:clamp(24px,4.8vw,40px);line-height:1.2}
  h2{margin:.6em 0 .2em;font-size:clamp(18px,3.4vw,22px)}

  /* Cards & layout */
  .grid{display:grid;gap:16px}
  .cols{grid-template-columns:1fr}
  @media (min-width:980px){.cols{grid-template-columns:1.15fr .85fr}}
  .card{border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);
        background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0))}
  .muted{color:var(--muted)}
  .mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .tag{font-size:12px;color:#cfd3db;border:1px dashed var(--line);border-radius:8px;padding:2px 8px;white-space:nowrap}

  /* Hero */
  .hero{display:grid;gap:10px}
  .ribbon{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .actions{display:flex;flex-wrap:wrap;gap:8px}

  /* Calendar */
  .cal{display:grid;gap:10px}
  .calHead{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .calHead span{font-size:12px;color:#cfd3db;text-align:center}
  .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .day{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.02);display:grid;gap:6px;min-height:92px}
  .day:hover{outline:1px solid rgba(245,209,66,.35)}
  .dtop{display:flex;gap:6px;align-items:center;justify-content:space-between}
  .dnum{font-weight:700}
  .dmeta{display:flex;gap:6px;align-items:center}
  .dtitle{font-size:14px;line-height:1.3}
  .dartist{font-size:13px;color:#cfd3db}
  .badge{font-size:12px;color:var(--muted);border:1px dashed var(--line);border-radius:999px;padding:2px 8px;width:max-content}

  /* Tools */
  .tools{display:flex;flex-wrap:wrap;gap:8px;align-items:center}
  .right{margin-left:auto}
</style>
</head>
<body>
<div class="wrap">
  <!-- HERO -->
  <section class="card hero">
    <div class="ribbon">
      <span class="tag">Illumina 1 · Calendar</span>
      <span id="cycle" class="pill">Loading…</span>
      <span id="phaseLegend" class="pill">Phases: 🌑 🌒 🌓 🌔 🌕 🌖 🌗 🌘</span>
    </div>
    <h1 id="title">42 Days · Six Weeks · One Cycle</h1>
    <p class="muted">Click any day to open the Day page. YouTube is canonical; Apple Music/Spotify mirrors show on Tunes.</p>
    <div class="actions">
      <a id="startBtn" class="btn primary" href="/day/?day=1">Start at Day 1</a>
      <a id="resumeBtn" class="btn" href="/day/">Resume last day</a>
      <a class="btn" href="https://tunes.plnt.earth/" target="_blank" rel="noopener">Open Tunes</a>
    </div>
  </section>

  <!-- TOOLS -->
  <section class="card tools">
    <label class="pill" for="search">Search</label>
    <input id="search" type="text" placeholder="Title, artist, figure, seed…">
    <select id="filter" aria-label="Filter">
      <option value="all">All days</option>
      <option value="has">YouTube available</option>
      <option value="missing">YouTube missing</option>
    </select>
    <select id="dayJump" aria-label="Jump to day"><option value="">Jump to day…</option></select>
    <button id="shareBtn" class="btn right" type="button">Share Calendar</button>
  </section>

  <!-- CALENDAR + SIDEPANEL -->
  <section class="grid cols">
    <div class="card">
      <div class="cal">
        <div class="calHead">
          <span>Sun</span><span>Mon</span><span>Tue</span>
          <span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
        </div>
        <div id="calGrid" class="calGrid" aria-live="polite"></div>
      </div>
    </div>

    <aside class="card">
      <h2>Links</h2>
      <div class="row" style="gap:10px">
        <a class="btn" href="/interludes/" target="_blank" rel="noopener">Interludes</a>
        <a class="btn" href="/references/" target="_blank" rel="noopener">References</a>
        <a class="btn" href="/science/" target="_blank" rel="noopener">Science</a>
        <a class="btn" href="/archive/" target="_blank" rel="noopener">Archive</a>
      </div>
      <h2 style="margin-top:16px">How this works</h2>
      <p class="muted">The calendar pulls from a master JSON. Each day links to a Day page with an inline player and your Figure/Seed notes. “Resume” remembers your last opened day on this device.</p>
    </aside>
  </section>

  <footer class="muted" style="margin:24px 0 8px;text-align:center">
    PLNT Earth · Illumina
  </footer>
</div>

<script>
(function(){
  /* ===== Config ===== */
  var MASTER_JSON = '/Illumina1_Playlist_MASTER_3in1.json';
  var LANE = 'Explainer'; // calendar uses the public explainer lane

  /* ===== State ===== */
  var data=null, filteredTerm='', filterMode='all';

  /* ===== Elements ===== */
  var calGrid = document.getElementById('calGrid');
  var cycle = document.getElementById('cycle');
  var search = document.getElementById('search');
  var dayJump = document.getElementById('dayJump');
  var filterSel = document.getElementById('filter');
  var shareBtn = document.getElementById('shareBtn');
  var resumeBtn = document.getElementById('resumeBtn');

  function safe(v){ return v==null ? "" : String(v); }

  // Moon phase emoji (approx)
  function moonEmoji(dateStr){
    if(!dateStr) return '';
    var d = new Date(dateStr+'T00:00:00Z'), syn=29.53058867, base=Date.UTC(2025,0,29);
    var days=(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())-base)/86400000;
    var phase=((days%syn)+syn)%syn;
    return ['🌑','🌒','🌓','🌔','🌕','🌖','🌗','🌘'][Math.floor((phase/syn)*8+0.5)%8];
  }

  function match(row, fig, seed){
    if(!filteredTerm) return true;
    var t=filteredTerm.toLowerCase();
    return (safe(row.title).toLowerCase().indexOf(t)>-1) ||
           (safe(row.artist).toLowerCase().indexOf(t)>-1) ||
           (safe(fig).toLowerCase().indexOf(t)>-1) ||
           (safe(seed).toLowerCase().indexOf(t)>-1);
  }

  function hasYT(row){
    var url = row && row.Platforms && row.Platforms.YouTube && row.Platforms.YouTube.url;
    return !!url;
  }

  function buildCalendar(){
    if(!data || !data.PerDay){ calGrid.innerHTML=''; return; }
    var list = data.PerDay;
    var start = list[0] && list[0].Date ? new Date(list[0].Date+'T00:00:00') : null;
    var offset = start ? (new Date(start).getDay()) : 0; // 0=Sun

    var cells=[];
    for(var i=0;i<offset;i++){
      cells.push('<div class="day" aria-hidden="true" style="opacity:.25"></div>');
    }

    // Fill days
    for(var i=0;i<list.length;i++){
      var base = list[i], d = base.Day, date = base.Date;
      var row = base[LANE] || {};
      var fig = base.Figure, seed = base.SeedRitual;

      if(!match(row, fig, seed)) continue;
      if(filterMode==='has' && !hasYT(row)) continue;
      if(filterMode==='missing' && hasYT(row)) continue;

      var phase = moonEmoji(date);
      var dayHref = '/day/?date='+encodeURIComponent(date||'');
      var title = safe(row.title), artist = safe(row.artist);
      var yt = hasYT(row);

      cells.push(
        '<a class="day" href="'+dayHref+'" id="d-'+d+'">'+
          '<div class="dtop">'+
            '<span class="dnum">Day '+d+'</span>'+
            '<div class="dmeta"><span class="badge mono">'+safe(date)+'</span><span class="badge">'+phase+'</span></div>'+
          '</div>'+
          '<div class="dtitle">'+title+'</div>'+
          '<div class="dartist">'+artist+'</div>'+
          (yt?'<div class="badge">YouTube</div>':'<div class="badge" style="color:#f3c6c6">Missing</div>')+
        '</a>'
      );
    }

    calGrid.innerHTML = cells.join('');

    // Jump
    var opts = ['<option value="">Jump to day…</option>'];
    for(var k=0;k<list.length;k++){ opts.push('<option value="'+(k+1)+'">Day '+(k+1)+'</option>'); }
    dayJump.innerHTML = opts.join('');
  }

  function render(){
    if(!data || !data.PerDay){ cycle.textContent='No data'; calGrid.innerHTML=''; return; }
    var start = data.Cycle && data.Cycle.Start ? data.Cycle.Start : '—';
    var end   = data.Cycle && data.Cycle.End   ? data.Cycle.End   : '—';
    cycle.textContent = 'Cycle: '+start+' → '+end+' · Days: '+(data.PerDay?data.PerDay.length:'—');
    buildCalendar();
  }

  function load(){
    fetch(MASTER_JSON, {cache:'no-store'})
      .then(function(r){ return r.json(); })
      .then(function(json){ data = json; render(); })
      .catch(function(){ cycle.textContent='Load error'; calGrid.innerHTML=''; });
  }

  // Remember last day (reads what Day page or Tunes stored)
  function lastDay(){
    // Read from JAR day local key OR Tunes pattern if you saved one; fallback day=1
    var keys = Object.keys(localStorage);
    var jarKey = keys.find(k=>/^jar_note_/.test(k)); // any note implies a day/date used
    var dayFromJar = null;
    if(jarKey){
      var m = jarKey.match(/^jar_note_(day_(\d+)|\d{4}-\d{2}-\d{2})$/);
      if(m){
        dayFromJar = m[2] ? parseInt(m[2],10) : null; // we use day_N form if present
      }
    }
    // If you later store a canonical "last_day" key, we can read it here instead.
    return (dayFromJar && dayFromJar>=1 && dayFromJar<=42) ? dayFromJar : 1;
  }

  // UI bindings
  search.addEventListener('input', function(){ filteredTerm=this.value.trim(); render(); });
  filterSel.addEventListener('change', function(){ filterMode=this.value; render(); });
  dayJump.addEventListener('change', function(){ var v=parseInt(this.value||'',10); if(v){ location.href='/day/?day='+v; } });
  shareBtn.addEventListener('click', function(){
    if(navigator.clipboard && navigator.clipboard.writeText){
      navigator.clipboard.writeText(location.href);
      this.textContent='Copied!'; var self=this; setTimeout(function(){ self.textContent='Share Calendar'; }, 900);
    }
  });

  // Wire Resume button
  (function initResume(){
    var d = lastDay();
    resumeBtn.href = '/day/?day='+d;
  })();

  load();
})();
</script>
</body>
</html>
