<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>Dreams ¬∑ plnt.earth</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Ctext y='0.9em' font-size='90'%3Eüåô%3C/text%3E%3C/svg%3E">
<style>
:root{--bg:#0b0b0d;--panel:#121216;--ink:#eaeaf2;--muted:#a9adc2;--accent:#9dfcff;--accent2:#ffd36b;--ring:rgba(157,252,255,.35);--chip:#191922}
*{box-sizing:border-box}html,body{height:100%}
body{margin:0;background:radial-gradient(1200px 800px at 10% -10%,rgba(157,252,255,.06),transparent 60%),radial-gradient(900px 600px at 110% 10%,rgba(255,211,107,.06),transparent 60%),var(--bg);color:var(--ink);font:15px/1.45 system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial}
a{color:var(--accent);text-decoration:none}.wrap{max-width:1100px;margin:auto;padding:20px}
header{display:flex;flex-wrap:wrap;gap:10px 16px;align-items:center;justify-content:space-between;margin-bottom:16px}
.brand{display:flex;align-items:center;gap:10px}.dot{width:12px;height:12px;border-radius:999px;background:linear-gradient(135deg,var(--accent),var(--accent2))}
nav{display:flex;flex-wrap:wrap;gap:8px}nav a{padding:8px 10px;background:#191922;border:1px solid #22232c;border-radius:10px}
h1{font-size:24px;margin:8px 0 4px}.sub{color:var(--muted)}
.panel{background:var(--panel);border:1px solid #1e2030;border-radius:16px;padding:14px;box-shadow:0 0 0 1px rgba(157,252,255,.03) inset}
.controls{display:flex;flex-wrap:wrap;gap:8px}
.btn{padding:10px 12px;border-radius:10px;border:1px solid #23263a;background:#151726;color:#e9ecff}
.grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.field{display:grid;gap:6px}
.input,textarea,select{width:100%;padding:8px 10px;border-radius:10px;border:1px solid #2a2d40;background:#10121a;color:#eaeaf2}
table{border-collapse:separate;border-spacing:0;width:100%}
th,td{padding:10px 12px;border-bottom:1px solid #1f2030;vertical-align:top}
.badge{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #2a2d40;background:#141623;color:#cfd3ea;font-size:12px}
.list{max-height:360px;overflow:auto;border:1px solid #1f2030;border-radius:12px}
.footer{margin-top:12px;color:var(--muted);display:flex;justify-content:space-between;gap:8px;flex-wrap:wrap}
.canvasWrap{border:1px solid #1f2030;border-radius:12px;overflow:hidden}
.hidden{display:none}
@media (max-width:900px){.grid{grid-template-columns:1fr}}
</style>
</head>
<body>
<div class="wrap">
  <header>
    <div class="brand"><div class="dot"></div><div><h1>Dreams</h1><div class="sub">Trace ¬∑ Weekly Patterns ¬∑ End-of-Cycle Map</div></div></div>
    <nav>
      <a href="/">Jar</a><a href="/calendar/illumina1/">Calendar</a><a href="/day/">Day</a>
      <a href="/tunes/">Tunes</a><a href="/interludes/">Interludes</a><a href="/seeds/">Seeds</a>
      <a href="/references/">References</a><a href="/references/archive/">Archive</a><a href="/references/science/">Science</a>
      <a href="/compatibility/">Compatibility</a><a href="/modes/neon/">Neon</a><a href="/storage/">Storage</a><a href="/pollen/">Pollen</a>
    </nav>
  </header>

  <div class="panel" style="margin-bottom:12px">
    <div class="controls">
      <button class="btn" id="exportBtn">Export JSON</button>
      <label class="btn" for="importFile" style="cursor:pointer">Import JSON</label>
      <input id="importFile" type="file" accept="application/json" class="hidden" />
      <button class="btn" id="resetBtn">Reset</button>
      <button class="btn" id="addQuick">+ Add Entry</button>
    </div>
  </div>

  <div class="grid">
    <div class="panel">
      <h3 style="margin:0 0 8px">Dream Trace</h3>
      <div class="field"><label>Date</label><input id="dDate" class="input" type="date"></div>
      <div class="field"><label>Mood</label>
        <select id="dMood" class="input">
          <option>üôÇ calm</option><option>üò¥ sleepy</option><option>üòµ‚Äçüí´ surreal</option>
          <option>üò® anxious</option><option>üòä joyful</option><option>üî• intense</option>
        </select>
      </div>
      <div class="field"><label>Tags (comma)</label><input id="dTags" class="input" placeholder="water, chase, city, neon"></div>
      <div class="field"><label>Notes</label><textarea id="dNotes" rows="6" class="input" placeholder="What happened? Who appeared? Sensations, colors, symbols‚Ä¶"></textarea></div>
      <div class="controls"><button class="btn" id="saveBtn">Save Entry</button></div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px">Weekly Pattern</h3>
      <div class="list">
        <table id="weekly">
          <thead><tr><th>Week #</th><th>Top Tags</th><th>Moods</th><th>Count</th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>

    <div class="panel canvasWrap">
      <h3 style="margin:0 0 8px">End-of-Cycle Dream Map</h3>
      <canvas id="map" width="1000" height="500" style="width:100%;height:320px;display:block;background:#0f1119"></canvas>
      <div class="sub" style="margin-top:6px">Shows top recurring tags as nodes; proximity reflects co-occurrence.</div>
    </div>

    <div class="panel">
      <h3 style="margin:0 0 8px">Entries</h3>
      <div class="list">
        <table id="entries">
          <thead><tr><th>Date</th><th>Mood</th><th>Tags</th><th>Notes</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div class="footer">
    <div>Local key: <span class="badge">jar_dreams_v1</span></div>
    <div>Tip: review patterns on Day 7, 14, 21, 42.</div>
  </div>
</div>

<script>
const KEY="jar_dreams_v1";
const entriesTbody=document.querySelector("#entries tbody");
const weeklyTbody=document.querySelector("#weekly tbody");
const dDate=document.getElementById("dDate");
const dMood=document.getElementById("dMood");
const dTags=document.getElementById("dTags");
const dNotes=document.getElementById("dNotes");
const map=document.getElementById("map"); const ctx=map.getContext("2d");

function load(){try{const raw=localStorage.getItem(KEY);return raw?JSON.parse(raw):[]}catch(_){return []}}
function save(rows){localStorage.setItem(KEY,JSON.stringify(rows))}
function addEntry(){
  const rows=load();
  const row={date:dDate.value||new Date().toISOString().slice(0,10),mood:dMood.value,tags:(dTags.value||"").split(",").map(s=>s.trim()).filter(Boolean),notes:dNotes.value.trim()};
  rows.push(row); save(rows); render(); dTags.value=""; dNotes.value="";
}
function removeEntry(idx){const rows=load(); rows.splice(idx,1); save(rows); render()}
function byWeek(date){const d=new Date(date+"T00:00:00"); const s=new Date(d.getFullYear(),0,1); const days=Math.floor((d-s)/86400000)+1; return Math.ceil(days/7)}

function renderList(){
  const rows=load(); entriesTbody.innerHTML="";
  rows.slice().reverse().forEach((r,revIdx)=>{
    const idx=rows.length-1-revIdx;
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${r.date}</td><td>${r.mood}</td><td>${r.tags.map(t=>`<span class="badge">${t}</span>`).join(" ")}</td><td>${(r.notes||"").replace(/</g,"&lt;")}</td><td><button class="btn" data-del="${idx}">‚úï</button></td>`;
    entriesTbody.appendChild(tr);
  });
  entriesTbody.querySelectorAll("button[data-del]").forEach(b=>b.addEventListener("click",()=>removeEntry(parseInt(b.dataset.del,10))));
}
function renderWeekly(){
  const rows=load(); weeklyTbody.innerHTML="";
  const groups={};
  rows.forEach(r=>{
    const w=byWeek(r.date);
    groups[w]=groups[w]||{tags:{},moods:{},count:0};
    r.tags.forEach(t=>groups[w].tags[t]=(groups[w].tags[t]||0)+1);
    groups[w].moods[r.mood]=(groups[w].moods[r.mood]||0)+1;
    groups[w].count++;
  });
  Object.keys(groups).sort((a,b)=>parseInt(a)-parseInt(b)).forEach(w=>{
    const g=groups[w];
    const topTags=Object.entries(g.tags).sort((a,b)=>b[1]-a[1]).slice(0,5).map(([t,c])=>`${t} (${c})`).join(", ")||"‚Äî";
    const moods=Object.entries(g.moods).sort((a,b)=>b[1]-a[1]).map(([m,c])=>`${m}√ó${c}`).join(", ");
    const tr=document.createElement("tr");
    tr.innerHTML=`<td>${w}</td><td>${topTags}</td><td>${moods||"‚Äî"}</td><td>${g.count}</td>`;
    weeklyTbody.appendChild(tr);
  });
}
function renderMap(){
  const rows=load(); ctx.clearRect(0,0,map.width,map.height);
  const counts={}, co={};
  rows.forEach(r=>{
    r.tags.forEach(t=>counts[t]=(counts[t]||0)+1);
    for(let i=0;i<r.tags.length;i++) for(let j=i+1;j<r.tags.length;j++){
      const a=r.tags[i], b=r.tags[j]; const k=a<b?`${a}||${b}`:`${b}||${a}`;
      co[k]=(co[k]||0)+1;
    }
  });
  const tags=Object.entries(counts).sort((a,b)=>b[1]-a[1]).slice(0,14).map(([t,c])=>({tag:t,c}));
  if(tags.length===0) return;
  const nodes=tags.map((t,i)=>({tag:t.tag,c:t.c,x:120+((i*67)%760),y:80+((i*113)%320)}));
  ctx.globalAlpha=0.6;
  Object.entries(co).forEach(([k,v])=>{
    const [a,b]=k.split("||");
    const na=nodes.find(n=>n.tag===a), nb=nodes.find(n=>n.tag===b);
    if(!na||!nb) return;
    ctx.strokeStyle="rgba(157,252,255,0.18)";
    ctx.lineWidth=Math.min(3,0.6+v*0.2);
    ctx.beginPath(); ctx.moveTo(na.x,na.y); ctx.lineTo(nb.x,nb.y); ctx.stroke();
  });
  ctx.globalAlpha=1;
  nodes.forEach(n=>{
    const r=4+Math.min(10,n.c);
    ctx.fillStyle="rgba(255,211,107,0.9)"; ctx.beginPath(); ctx.arc(n.x,n.y,r,0,Math.PI*2); ctx.fill();
    ctx.fillStyle="#cfd3ea"; ctx.font="12px system-ui"; ctx.fillText(`${n.tag} (${n.c})`, n.x+8, n.y-8);
  });
}
function render(){renderList(); renderWeekly(); renderMap()}

document.getElementById("saveBtn").addEventListener("click",addEntry);
document.getElementById("addQuick").addEventListener("click",addEntry);
document.getElementById("exportBtn").addEventListener("click",()=>{
  const blob=new Blob([localStorage.getItem(KEY)||"[]"],{type:"application/json"});
  const url=URL.createObjectURL(blob); const a=document.createElement("a"); a.href=url; a.download="jar_dreams.json"; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url),500);
});
document.getElementById("importFile").addEventListener("change",e=>{
  const f=e.target.files&&e.target.files[0]; if(!f) return;
  const fr=new FileReader(); fr.onload=()=>{try{const data=JSON.parse(fr.result); if(Array.isArray(data)){localStorage.setItem(KEY,JSON.stringify(data)); render();}}catch(_){ } e.target.value="";}; fr.readAsText(f);
});
document.getElementById("resetBtn").addEventListener("click",()=>{localStorage.removeItem(KEY); render()});
(function init(){ if(!dDate.value){dDate.value=new Date().toISOString().slice(0,10)} render() })();
</script>
</body>
</html>
