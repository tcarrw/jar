<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Jar ‚Äî Index</title>
  <meta name="color-scheme" content="light dark" />
  <style>
    :root{
      --bg:#0b0f14;
      --surface:#111827;
      --surface-2:#0f172a;
      --text:#e5e7eb;
      --muted:#94a3b8;
      --border:#1f2737;
      --accent:#7c3aed;
      --accent-ink:#ffffff;
      --success:#10b981;
      --danger:#ef4444;
      --shadow:0 8px 24px rgba(0,0,0,.28);
      --radius:12px;
      --radius-sm:10px;
      --radius-xs:8px;
      --ring:0 0 0 2px color-mix(in oklab, var(--accent) 30%, transparent);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7fafc;
        --surface:#ffffff;
        --surface-2:#f8fafc;
        --text:#0f172a;
        --muted:#475569;
        --border:#e2e8f0;
        --accent:#6d28d9;
        --accent-ink:#ffffff;
        --shadow:0 8px 20px rgba(17,24,39,.08);
      }
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font:16px/1.5 ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Apple Color Emoji","Segoe UI Emoji";
      background: radial-gradient(1200px 800px at 20% -10%, color-mix(in oklab, var(--accent) 16%, transparent), transparent), var(--bg);
      color:var(--text);
      -webkit-font-smoothing:antialiased;
      -moz-osx-font-smoothing:grayscale;
    }
    .shell{max-width:1100px; margin:24px auto 56px; padding:0 16px}
    header{
      display:flex; align-items:center; justify-content:space-between; gap:16px;
      background:linear-gradient(180deg, color-mix(in oklab, var(--surface) 94%, transparent), var(--surface));
      border:1px solid var(--border); border-radius:var(--radius); padding:18px 20px; box-shadow:var(--shadow);
      position:sticky; top:12px; z-index:5; backdrop-filter:saturate(1.2) blur(6px)
    }
    .brand{display:flex; align-items:center; gap:12px; font-weight:700; letter-spacing:.2px}
    .glyph{display:inline-grid; place-items:center; width:32px; height:32px; border-radius:8px; background:var(--accent); color:var(--accent-ink); font-size:18px}
    .brand h1{font-size:18px; margin:0}

    .btn{
      border:1px solid var(--border); background:var(--surface-2); color:var(--text);
      padding:10px 12px; border-radius:var(--radius-xs); cursor:pointer; transition:transform .04s ease;
    }
    .btn:hover{transform:translateY(-1px)}
    .btn:focus-visible{outline:none; box-shadow:var(--ring)}
    .btn.primary{background:var(--accent); color:var(--accent-ink); border-color:color-mix(in oklab, var(--accent) 40%, var(--border))}
    .btn.ghost{background:transparent}
    .btn.mini{font-size:12px; padding:6px 8px}

    .muted{color:var(--muted); font-size:12px}
    .pill{
      display:inline-flex; align-items:center; gap:8px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--border); background:var(--surface-2); font-size:12px; color:var(--muted)
    }
    .pill[data-type="Honey"]{background:color-mix(in oklab, var(--success) 18%, var(--surface-2)); color:color-mix(in oklab, var(--success) 84%, var(--text))}
    .pill[data-type="Gratitude"]{background:color-mix(in oklab, #f59e0b 22%, var(--surface-2)); color:color-mix(in oklab, #f59e0b 84%, var(--text))}
    .pill[data-type="Spark"]{background:color-mix(in oklab, var(--accent) 22%, var(--surface-2)); color:color-mix(in oklab, var(--accent) 84%, var(--text))}
    .pill[data-type="Task"]{background:color-mix(in oklab, #3b82f6 22%, var(--surface-2)); color:color-mix(in oklab, #3b82f6 86%, var(--text))}
    .pill[data-type="Note"]{background:color-mix(in oklab, #a3a3a3 22%, var(--surface-2)); color:color-mix(in oklab, #a3a3a3 90%, var(--text))}

    main{margin-top:18px; display:grid; grid-template-columns: 1.2fr .8fr; gap:18px}
    @media (max-width: 980px){ main{grid-template-columns:1fr}}
    .card{
      background:var(--surface); border:1px solid var(--border); border-radius:var(--radius); box-shadow:var(--shadow); padding:18px
    }
    .stack{display:grid; gap:14px}
    .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center}

    .toolbar{display:flex; flex-wrap:wrap; gap:10px; align-items:center; justify-content:space-between}
    .controls{display:flex; flex-wrap:wrap; gap:10px; align-items:center}

    input[type="month"], input[type="text"], input[type="date"], select{
      border:1px solid var(--border); background:var(--surface-2); color:var(--text);
      padding:10px 12px; border-radius:var(--radius-xs)
    }
    .checkset{display:flex; gap:8px; flex-wrap:wrap}
    .checkset label{display:inline-flex; align-items:center; gap:8px; border:1px dashed var(--border); padding:8px 10px; border-radius:999px; font-size:12px; color:var(--muted); background:var(--surface-2)}
    .checkset input{accent-color:var(--accent)}

    .cal{display:grid; gap:12px}
    .cal-head{display:grid; grid-template-columns:repeat(7,1fr); gap:8px; font-size:12px; color:var(--muted)}
    .cal-grid{display:grid; grid-template-columns:repeat(7,1fr); gap:8px}
    .cal-cell{
      display:grid; grid-template-rows:auto 1fr auto; gap:8px; min-height:92px;
      border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--surface-2); padding:10px;
      cursor:pointer; transition:transform .04s ease;
    }
    .cal-cell:hover{transform:translateY(-1px)}
    .cal-cell header{display:flex; align-items:center; justify-content:space-between}
    .cal-day{font-weight:600}
    .cal-count{font-size:12px; color:var(--muted)}
    .cal-badges{display:flex; gap:6px; flex-wrap:wrap}
    .badge{display:inline-flex; align-items:center; padding:2px 8px; border-radius:999px; font-size:11px; border:1px solid var(--border)}
    .cal-cell.selected{outline:2px solid color-mix(in oklab, var(--accent) 50%, transparent)}
    .cal-cell[data-dominant="Honey"]{border-color:color-mix(in oklab, var(--success) 60%, var(--border))}
    .cal-cell[data-dominant="Gratitude"]{border-color:color-mix(in oklab, #f59e0b 60%, var(--border))}
    .cal-cell[data-dominant="Spark"]{border-color:color-mix(in oklab, var(--accent) 60%, var(--border))}
    .cal-cell[data-dominant="Task"]{border-color:color-mix(in oklab, #3b82f6 60%, var(--border))}
    .cal-cell[data-dominant="Note"]{border-color:color-mix(in oklab, #a3a3a3 70%, var(--border))}

    .entry{
      display:grid; gap:10px; padding:14px; border:1px solid var(--border); border-radius:var(--radius-sm); background:var(--surface-2)
    }
    .entry-head{display:flex; align-items:center; justify-content:space-between; gap:10px; flex-wrap:wrap}
    .entry-text{white-space:pre-wrap; line-height:1.55}
    .entry-tags{display:flex; gap:8px; flex-wrap:wrap}
    .tag{display:inline-flex; align-items:center; padding:4px 8px; border-radius:999px; background:transparent; border:1px dashed var(--border); font-size:11px; color:var(--muted)}

    .split{display:grid; grid-template-columns:1fr 1fr; gap:12px}
    @media (max-width:760px){.split{grid-template-columns:1fr}}

    .toast{
      position:fixed; left:50%; bottom:20px; transform:translateX(-50%);
      background:var(--surface); border:1px solid var(--border); border-radius:10px; padding:10px 14px;
      box-shadow:var(--shadow); opacity:0; pointer-events:none; transition:opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; pointer-events:auto; transform:translateX(-50%) translateY(-4px)}
    .sr-only{position:absolute; width:1px; height:1px; padding:0; margin:-1px; overflow:hidden; clip:rect(0,0,0,0); white-space:nowrap; border:0}
    a.link{color:color-mix(in oklab, var(--accent) 88%, var(--text)); text-decoration:none; border-bottom:1px dashed color-mix(in oklab, var(--accent) 60%, var(--border))}
    a.link:hover{border-bottom-style:solid}
  </style>
</head>
<body>
  <a class="sr-only" href="#content">Skip to content</a>
  <div class="shell">
    <header>
      <div class="brand" aria-live="polite" aria-atomic="true">
        <div class="glyph" aria-hidden="true">üçØ</div>
        <h1 id="brand">Jar ‚Äî Index</h1>
      </div>
      <div class="controls">
        <button class="btn" id="prevMonth" aria-label="Previous month">‚Üê</button>
        <input id="monthPicker" type="month" />
        <button class="btn" id="nextMonth" aria-label="Next month">‚Üí</button>
        <button class="btn ghost" id="jumpToday">Today</button>
      </div>
    </header>

    <main id="content">
      <section class="card stack">
        <div class="toolbar">
          <div class="controls" style="gap:14px">
            <div class="checkset" id="typeChecks"></div>
            <input id="tagFilter" type="text" placeholder="#tag filter (space/comma/#)" />
            <input id="textFilter" type="text" placeholder="Search text‚Ä¶" />
          </div>
          <div class="controls">
            <button class="btn" id="exportMonth">Export Month JSON</button>
            <button class="btn" id="exportAll">Export All JSON</button>
            <button class="btn" id="exportMonthCSV">Export Month CSV</button>
            <label class="btn" for="importFile" style="cursor:pointer">Import JSON</label>
            <input id="importFile" type="file" accept="application/json" hidden />
            <button class="btn" id="clearMonth">Clear Month</button>
            <button class="btn" id="clearAll">Clear All</button>
          </div>
        </div>
        <div class="muted" id="summary" aria-live="polite"></div>
      </section>

      <section class="card stack">
        <div class="cal">
          <div class="cal-head">
            <div>Sun</div><div>Mon</div><div>Tue</div><div>Wed</div><div>Thu</div><div>Fri</div><div>Sat</div>
          </div>
          <div class="cal-grid" id="calGrid"></div>
        </div>
      </section>

      <section class="card stack">
        <div class="toolbar">
          <h2 style="margin:0;font-size:16px">Selected Day</h2>
          <div class="controls">
            <div class="muted" id="dayTitle"></div>
            <a id="openDayLink" class="btn ghost" href="/jar/day/" rel="noopener">Open in Day</a>
          </div>
        </div>
        <div class="split">
          <div class="stack">
            <div class="row" id="dayStatbar"></div>
            <div id="dayEmpty" class="muted">No entries match filters.</div>
            <div id="dayEntries" class="stack"></div>
          </div>
          <div class="stack">
            <div class="row" id="monthStatbar"></div>
            <div class="stack" id="tagCloud"></div>
          </div>
        </div>
      </section>

      <section class="card stack">
        <h2 style="margin:0;font-size:16px">About Data</h2>
        <p class="muted">Data is stored locally in your browser under a namespaced key. Export regularly if you need backups or to merge with other devices.</p>
      </section>
    </main>
  </div>

  <div id="toast" class="toast" role="status" aria-live="polite" aria-atomic="true"></div>

  <script src="/api/config.js" defer></script>
  <script defer>
    (function(){
      "use strict";

      const $ = (s, r=document) => r.querySelector(s);
      const $$ = (s, r=document) => Array.from(r.querySelectorAll(s));

      const els = {
        brand: $("#brand"),
        prevMonth: $("#prevMonth"),
        nextMonth: $("#nextMonth"),
        jumpToday: $("#jumpToday"),
        monthPicker: $("#monthPicker"),
        typeChecks: $("#typeChecks"),
        tagFilter: $("#tagFilter"),
        textFilter: $("#textFilter"),
        summary: $("#summary"),
        calGrid: $("#calGrid"),
        dayTitle: $("#dayTitle"),
        openDayLink: $("#openDayLink"),
        dayEntries: $("#dayEntries"),
        dayEmpty: $("#dayEmpty"),
        dayStatbar: $("#dayStatbar"),
        monthStatbar: $("#monthStatbar"),
        tagCloud: $("#tagCloud"),
        exportMonth: $("#exportMonth"),
        exportAll: $("#exportAll"),
        exportMonthCSV: $("#exportMonthCSV"),
        importFile: $("#importFile"),
        clearMonth: $("#clearMonth"),
        clearAll: $("#clearAll"),
        toast: $("#toast")
      };

      const cfg = (window.APP_CONFIG && typeof window.APP_CONFIG === "object") ? window.APP_CONFIG : {};
      const ns = cfg.namespace || cfg.appId || "default";
      const storageKey = `jar.v1.${ns}`;
      const accent = (cfg.theme && cfg.theme.accent) ? String(cfg.theme.accent) : null;
      if (accent) document.documentElement.style.setProperty("--accent", accent);
      if (cfg.brand || cfg.title){
        const label = `${cfg.brand || cfg.title} ‚Äî Index`;
        els.brand.textContent = label;
        document.title = label;
      }

      const TYPES = ["Honey","Gratitude","Spark","Task","Note"];

      let state = {
        year: new Date().getFullYear(),
        month: new Date().getMonth(),
        selectedISO: toISO(new Date()),
        types: new Set(TYPES),
        tagTokens: [],
        textQuery: ""
      };

      function toISO(d){
        const y = d.getFullYear();
        const m = String(d.getMonth()+1).padStart(2,"0");
        const dd = String(d.getDate()).padStart(2,"0");
        return `${y}-${m}-${dd}`;
      }
      function fromISO(iso){
        const [y,m,d] = iso.split("-").map(Number);
        return new Date(y, m-1, d);
      }
      function monthStr(y,m){
        return `${y}-${String(m+1).padStart(2,"0")}`;
      }
      function todayISO(){ return toISO(new Date()); }
      function humanDate(iso){
        const d = fromISO(iso);
        return d.toLocaleDateString(undefined, {weekday:"short", year:"numeric", month:"short", day:"numeric"});
      }
      function parseTags(raw){
        if (!raw) return [];
        return raw.split(/[\s,]+/).map(s=>s.trim().replace(/^#/, "")).filter(Boolean).slice(0, 16);
      }

      let memoryDB = {};
      function readDB(){
        try{
          const raw = localStorage.getItem(storageKey);
          if (!raw) return {};
          const obj = JSON.parse(raw);
          return (obj && typeof obj === "object") ? obj : {};
        }catch(_){ return Object.assign({}, memoryDB); }
      }
      function writeDB(obj){
        try{ localStorage.setItem(storageKey, JSON.stringify(obj)); }
        catch(_){ memoryDB = Object.assign({}, obj); }
      }

      function monthBounds(y,m){
        const start = new Date(y, m, 1);
        const end = new Date(y, m+1, 0);
        return {start, end, days: end.getDate(), startDow: start.getDay()};
      }
      function isSameMonth(iso, y, m){
        const [yy, mm] = iso.split("-").map(Number);
        return (yy === y && (mm-1) === m);
      }
      function filterEntry(e){
        if (!state.types.has(e.type)) return false;
        if (state.textQuery){
          const q = state.textQuery.toLowerCase();
          const inText = String(e.text||"").toLowerCase().includes(q);
          const inTags = (e.tags||[]).some(t => String(t).toLowerCase().includes(q));
          if (!inText && !inTags) return false;
        }
        if (state.tagTokens.length){
          const tags = new Set((e.tags||[]).map(String));
          const ok = state.tagTokens.some(t => tags.has(t));
          if (!ok) return false;
        }
        return true;
      }
      function dayStats(entries){
        const counts = entries.reduce((a,e)=>{ a[e.type]=(a[e.type]||0)+1; return a; }, {});
        const total = entries.length;
        return {counts, total};
      }
      function dominantType(entries){
        const c = entries.reduce((a,e)=>{ a[e.type]=(a[e.type]||0)+1; return a; }, {});
        let best=null, max=-1;
        TYPES.forEach(t=>{ const v=c[t]||0; if (v>max){ max=v; best=t; }});
        return best;
      }
      function monthData(){
        const db = readDB();
        const data = {};
        Object.keys(db).forEach(iso=>{
          if (!isSameMonth(iso, state.year, state.month)) return;
          const filtered = db[iso].filter(filterEntry);
          data[iso] = filtered;
        });
        return data;
      }

      function showToast(msg){
        els.toast.textContent = msg;
        els.toast.classList.add("show");
        setTimeout(()=> els.toast.classList.remove("show"), 1400);
      }

      function renderTypeChecks(){
        els.typeChecks.innerHTML = "";
        TYPES.forEach(t=>{
          const id = `type-${t}`;
          const wrap = document.createElement("label");
          const box = document.createElement("input");
          box.type = "checkbox";
          box.id = id;
          box.checked = state.types.has(t);
          box.addEventListener("change", ()=>{
            if (box.checked) state.types.add(t); else state.types.delete(t);
            renderAll();
          });
          const name = document.createElement("span");
          name.textContent = t;
          wrap.appendChild(box);
          wrap.appendChild(name);
          els.typeChecks.appendChild(wrap);
        });
      }

      function renderSummary(monthMap){
        const daysWith = Object.values(monthMap).filter(v=>v && v.length).length;
        const total = Object.values(monthMap).reduce((a,v)=> a + v.length, 0);
        els.summary.textContent = `${new Date(state.year, state.month).toLocaleDateString(undefined, {month:"long", year:"numeric"})} ‚Ä¢ ${total} item${total===1?"":"s"} across ${daysWith} day${daysWith===1?"":"s"}`;
      }

      function pill(type, text){
        const n = document.createElement("div");
        n.className = "pill";
        if (type) n.dataset.type = type;
        n.textContent = text;
        return n;
      }

      function renderMonthStatbar(monthMap){
        els.monthStatbar.innerHTML = "";
        const all = Object.values(monthMap).flat();
        const {counts,total} = dayStats(all);
        const frag = document.createDocumentFragment();
        Object.entries(counts).forEach(([k,v])=> frag.appendChild(pill(k, `${k}: ${v}`)));
        frag.appendChild(pill(null, `Total: ${total}`));
        els.monthStatbar.appendChild(frag);
      }

      function renderTagCloud(monthMap){
        els.tagCloud.innerHTML = "";
        const tags = {};
        Object.values(monthMap).flat().forEach(e=>{
          (e.tags||[]).forEach(t=> tags[t] = (tags[t]||0)+1);
        });
        const entries = Object.entries(tags).sort((a,b)=> b[1]-a[1]).slice(0,24);
        if (!entries.length){
          const p = document.createElement("div");
          p.className = "muted";
          p.textContent = "No tags yet.";
          els.tagCloud.appendChild(p);
          return;
        }
        const row = document.createElement("div");
        row.className = "row";
        entries.forEach(([t,c])=>{
          const chip = document.createElement("div");
          chip.className = "tag";
          chip.textContent = `#${t} (${c})`;
          chip.style.cursor = "pointer";
          chip.addEventListener("click", ()=>{
            const current = new Set(state.tagTokens);
            if (current.has(t)) current.delete(t); else current.add(t);
            state.tagTokens = Array.from(current);
            els.tagFilter.value = state.tagTokens.map(x=>`#${x}`).join(" ");
            renderAll();
          });
          row.appendChild(chip);
        });
        els.tagCloud.appendChild(row);
      }

      function renderCalendar(monthMap){
        els.calGrid.innerHTML = "";
        const {days, startDow} = monthBounds(state.year, state.month);
        for (let i=0;i<startDow;i++){
          const blank = document.createElement("div");
          els.calGrid.appendChild(blank);
        }
        for (let d=1; d<=days; d++){
          const iso = toISO(new Date(state.year, state.month, d));
          const entries = monthMap[iso] || [];
          const cell = document.createElement("div");
          cell.className = "cal-cell";
          if (entries.length){
            const dom = dominantType(entries);
            if (dom) cell.dataset.dominant = dom;
          }
          if (iso === state.selectedISO) cell.classList.add("selected");

          const head = document.createElement("header");
          const dayNo = document.createElement("div");
          dayNo.className = "cal-day";
          dayNo.textContent = String(d);
          const count = document.createElement("div");
          count.className = "cal-count";
          count.textContent = entries.length ? `${entries.length}` : "";
          head.appendChild(dayNo);
          head.appendChild(count);

          const badges = document.createElement("div");
          badges.className = "cal-badges";
          if (entries.length){
            const c = entries.reduce((a,e)=>{ a[e.type]=(a[e.type]||0)+1; return a; }, {});
            Object.entries(c).sort((a,b)=> b[1]-a[1]).forEach(([k,v])=>{
              const b = document.createElement("span");
              b.className = "badge";
              b.textContent = `${k}: ${v}`;
              badges.appendChild(b);
            });
          }

          const foot = document.createElement("div");
          const open = document.createElement("a");
          open.href = "/jar/day/?date="+iso;
          open.className = "link";
          open.textContent = "Open";
          foot.appendChild(open);

          cell.appendChild(head);
          cell.appendChild(badges);
          cell.appendChild(foot);

          cell.addEventListener("click", ()=>{
            state.selectedISO = iso;
            renderDay(monthMap);
            $$(".cal-cell", els.calGrid).forEach(n=> n.classList.remove("selected"));
            cell.classList.add("selected");
          });

          els.calGrid.appendChild(cell);
        }
      }

      function entryCard(e){
        const wrap = document.createElement("div");
        wrap.className = "entry";
        const head = document.createElement("div");
        head.className = "entry-head";
        const left = document.createElement("div");
        left.style.display = "flex";
        left.style.gap = "8px";
        left.style.alignItems = "center";
        const pillType = document.createElement("span");
        pillType.className = "pill";
        pillType.dataset.type = e.type;
        pillType.textContent = e.type;
        const time = document.createElement("span");
        time.className = "muted";
        time.textContent = new Date(e.createdAt).toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
        left.appendChild(pillType);
        left.appendChild(time);
        head.appendChild(left);
        const txt = document.createElement("div");
        txt.className = "entry-text";
        txt.textContent = e.text;
        const tags = document.createElement("div");
        tags.className = "entry-tags";
        if (e.tags && e.tags.length){
          e.tags.forEach(t=>{
            const chip = document.createElement("span");
            chip.className = "tag";
            chip.textContent = `#${t}`;
            tags.appendChild(chip);
          });
        } else {
          const none = document.createElement("span");
          none.className = "muted";
          none.textContent = "No tags";
          tags.appendChild(none);
        }
        wrap.appendChild(head);
        wrap.appendChild(txt);
        wrap.appendChild(tags);
        return wrap;
      }

      function renderDay(monthMap){
        const iso = state.selectedISO;
        els.dayTitle.textContent = humanDate(iso);
        els.openDayLink.href = "/jar/day/?date="+iso;
        const list = monthMap[iso] || [];
        els.dayEntries.innerHTML = "";
        els.dayStatbar.innerHTML = "";
        els.dayEmpty.style.display = list.length ? "none" : "block";
        if (!list.length) return;
        const {counts,total} = dayStats(list);
        const frag = document.createDocumentFragment();
        Object.entries(counts).forEach(([k,v])=> frag.appendChild(pill(k, `${k}: ${v}`)));
        frag.appendChild(pill(null, `Total: ${total}`));
        els.dayStatbar.appendChild(frag);
        const stack = document.createDocumentFragment();
        list.sort((a,b)=> (a.createdAt > b.createdAt ? 1 : -1)).forEach(e=> stack.appendChild(entryCard(e)));
        els.dayEntries.appendChild(stack);
      }

      function exportBlob(name, obj){
        const blob = new Blob([JSON.stringify(obj, null, 2)], {type:"application/json"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = name;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }
      function exportCSVMonth(monthMap){
        const rows = [["date","time","type","text","tags"]];
        Object.entries(monthMap).forEach(([iso, list])=>{
          list.forEach(e=>{
            const t = new Date(e.createdAt);
            const time = t.toLocaleTimeString([], {hour:"2-digit", minute:"2-digit"});
            const text = String(e.text||"").replace(/"/g,'""');
            const tags = (e.tags||[]).join("|").replace(/"/g,'""');
            rows.push([iso, time, e.type, `"${text}"`, `"${tags}"`]);
          });
        });
        const csv = rows.map(r=> r.join(",")).join("\n");
        const blob = new Blob([csv], {type:"text/csv;charset=utf-8"});
        const url = URL.createObjectURL(blob);
        const a = document.createElement("a");
        a.href = url; a.download = `${monthStr(state.year,state.month)}-jar.csv`;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      }

      function onImport(file){
        if (!file) return;
        const fr = new FileReader();
        fr.onload = () => {
          let data;
          try{ data = JSON.parse(fr.result); }catch(_){ showToast("Invalid JSON"); return; }
          const db = readDB();
          if (Array.isArray(data)){
            const iso = state.selectedISO || todayISO();
            db[iso] = (db[iso]||[]).concat(data);
            writeDB(db);
            renderAll();
            showToast("Imported entries");
            return;
          }
          if (data && Array.isArray(data.entries)){
            const iso = data.date || todayISO();
            db[iso] = (db[iso]||[]).concat(data.entries);
            writeDB(db);
            renderAll();
            showToast("Imported entries");
            return;
          }
          if (data && typeof data === "object"){
            writeDB(Object.assign({}, db, data));
            renderAll();
            showToast("Imported data");
            return;
          }
          showToast("Nothing to import");
        };
        fr.readAsText(file);
      }

      function clearMonth(){
        const db = readDB();
        const keys = Object.keys(db).filter(iso => isSameMonth(iso, state.year, state.month));
        if (!keys.length) return;
        keys.forEach(k => delete db[k]);
        writeDB(db);
      }

      function renderAll(){
        const y = state.year, m = state.month;
        els.monthPicker.value = monthStr(y,m);
        const map = monthData();
        renderSummary(map);
        renderCalendar(map);
        renderMonthStatbar(map);
        renderTagCloud(map);
        if (!isSameMonth(state.selectedISO, y, m)){
          const first = Object.keys(map).sort()[0] || toISO(new Date(y,m,1));
          state.selectedISO = first;
        }
        renderDay(map);
      }

      els.prevMonth.addEventListener("click", ()=>{
        const d = new Date(state.year, state.month, 1);
        d.setMonth(d.getMonth()-1);
        state.year = d.getFullYear(); state.month = d.getMonth();
        renderAll();
      });
      els.nextMonth.addEventListener("click", ()=>{
        const d = new Date(state.year, state.month, 1);
        d.setMonth(d.getMonth()+1);
        state.year = d.getFullYear(); state.month = d.getMonth();
        renderAll();
      });
      els.jumpToday.addEventListener("click", ()=>{
        const t = new Date();
        state.year = t.getFullYear(); state.month = t.getMonth(); state.selectedISO = toISO(t);
        renderAll();
      });
      els.monthPicker.addEventListener("change", ()=>{
        const v = els.monthPicker.value;
        if (!v) return;
        const [yy, mm] = v.split("-").map(Number);
        state.year = yy; state.month = mm-1;
        renderAll();
      });

      els.tagFilter.addEventListener("input", ()=>{
        state.tagTokens = parseTags(els.tagFilter.value);
        renderAll();
      });
      els.textFilter.addEventListener("input", ()=>{
        state.textQuery = String(els.textFilter.value||"").trim();
        renderAll();
      });

      els.exportMonth.addEventListener("click", ()=>{
        const map = monthData();
        exportBlob(`${monthStr(state.year,state.month)}-jar.json`, map);
      });
      els.exportAll.addEventListener("click", ()=>{
        exportBlob(`jar-all.json`, readDB());
      });
      els.exportMonthCSV.addEventListener("click", ()=>{
        const map = monthData();
        exportCSVMonth(map);
      });

      els.importFile.addEventListener("change", e => onImport(e.target.files && e.target.files[0]));
      els.clearMonth.addEventListener("click", ()=>{
        if (!confirm("Clear all entries for this month?")) return;
        clearMonth();
        renderAll();
        showToast("Month cleared");
      });
      els.clearAll.addEventListener("click", ()=>{
        if (!confirm("Clear all data?")) return;
        writeDB({});
        renderAll();
        showToast("All data cleared");
      });

      function initFromQuery(){
        const p = new URLSearchParams(location.search);
        const d = p.get("date");
        if (d && /^\d{4}-\d{2}-\d{2}$/.test(d)){
          const dt = fromISO(d);
          state.year = dt.getFullYear();
          state.month = dt.getMonth();
          state.selectedISO = d;
        }
      }

      function init(){
        initFromQuery();
        renderTypeChecks();
        renderAll();
      }

      init();
    })();
  </script>
</body>
</html>
