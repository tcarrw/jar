<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>JAR Â· Illumina 1</title>
<meta name="theme-color" content="#0B0F19">
<meta name="description" content="Illumina 1 calendar with fixed player, day links, moon phases, and quick navigation.">
<style>
  :root{--bg:#0B0F19;--ink:#E5E7EB;--muted:#9CA3AF;--line:rgba(229,231,235,.14);
        --gold:#F5D142;--amber:#F59E0B;--ok:#34D399;--warn:#FBBF24;--err:#F87171;
        --r:14px;--pad:18px;--maxw:1200px}
  *{box-sizing:border-box}html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--ink);font:15px/1.55 ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;padding-top:260px}
  a{color:var(--gold);text-decoration:none}a:hover{text-decoration:underline}
  .wrap{max-width:var(--maxw);margin:0 auto;padding:clamp(14px,3.5vw,28px)}
  h1{margin:.2em 0 .2em;font-size:clamp(22px,4.6vw,34px);line-height:1.2}
  h2{margin:.6em 0 .2em;font-size:clamp(18px,3.4vw,22px)}
  .row{display:flex;flex-wrap:wrap;gap:10px;align-items:center}
  .btn{border:1px solid var(--line);border-radius:999px;padding:8px 12px;background:rgba(255,255,255,.02);color:var(--ink);cursor:pointer}
  .btn.primary{border-color:var(--amber);background:linear-gradient(180deg,rgba(245,209,66,.15),rgba(245,158,11,.12))}
  .pill{border:1px solid var(--line);border-radius:999px;padding:6px 10px;color:var(--muted);font-size:13px}
  input[type="text"], select{padding:10px 12px;border:1px solid var(--line);border-radius:999px;background:rgba(255,255,255,.02);color:var(--ink);font:inherit}
  .grid{display:grid;gap:14px}.cards{grid-template-columns:1fr}
  @media (min-width:980px){.cards{grid-template-columns:1.1fr .9fr}}
  .card{border:1px solid var(--line);border-radius:var(--r);padding:var(--pad);background:linear-gradient(180deg,rgba(255,255,255,.02),rgba(255,255,255,0))}
  .muted{color:var(--muted)}.mono{font-family:ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}
  .tag{font-size:12px;color:#cfd3db;border:1px dashed var(--line);border-radius:8px;padding:2px 8px;white-space:nowrap}

  /* Calendar */
  .cal{display:grid;gap:10px}
  .calHead{display:grid;grid-template-columns:repeat(7,1fr);gap:6px}
  .calHead span{font-size:12px;color:#cfd3db;text-align:center}
  .calGrid{display:grid;grid-template-columns:repeat(7,1fr);gap:8px}
  .day{border:1px solid var(--line);border-radius:12px;padding:10px;background:rgba(255,255,255,.02);display:grid;gap:6px;min-height:92px}
  .day:hover{outline:1px solid rgba(245,209,66,.35)}
  .dtop{display:flex;gap:6px;align-items:center;justify-content:space-between}
  .dnum{font-weight:700}.dmeta{display:flex;gap:6px;align-items:center}
  .dtitle{font-size:14px;line-height:1.3}.dartist{font-size:13px;color:#cfd3db}
  .badge{font-size:12px;color:var(--muted);border:1px dashed var(--line);border-radius:999px;padding:2px 8px;width:max-content}

  /* Fixed player header */
  .playerbar{position:fixed;left:0;right:0;top:0;z-index:9999;background:rgba(11,15,25,.96);
             backdrop-filter:saturate(120%) blur(10px);border-bottom:1px solid var(--line)}
  .playerwrap{max-width:var(--maxw);margin:0 auto;padding:8px 0 8px}
  .player-row{display:grid;gap:10px;grid-template-columns:1fr;align-items:center;padding:0 clamp(14px,3.5vw,28px)}
  @media (min-width:980px){.player-row{grid-template-columns:360px 1fr 220px}}
  .now{font-size:13px;color:var(--muted)} .now strong{color:#e9ecf3}
  .frame{position:relative;aspect-ratio:16/9;border:1px solid var(--line);border-radius:12px;overflow:hidden;background:rgba(255,255,255,.03)}
  .frame #yt{position:absolute;inset:0}
  .controls{display:flex;gap:8px;justify-content:flex-end;align-items:center}
</style>
</head>
<body>
<!-- Fixed Player -->
<div class="playerbar" aria-label="Player">
  <div class="playerwrap">
    <div class="player-row">
      <div>
        <div class="now">Now Playing â€” Explainer Lane</div>
        <div id="nowTitle" class="mono" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">â€”</div>
        <div id="nowMeta" class="muted" style="white-space:nowrap;overflow:hidden;text-overflow:ellipsis">â€”</div>
      </div>
      <div class="frame"><div id="yt"></div></div>
      <div class="controls">
        <button class="btn" id="prevBtn" type="button">âŸ¨ Prev</button>
        <button class="btn" id="nextBtn" type="button">Next âŸ©</button>
        <button class="btn primary" id="shareBtn" type="button">Share</button>
      </div>
    </div>
  </div>
</div>

<div class="wrap">
  <header class="card">
    <h1>Illumina 1 â€” Calendar</h1>
    <div class="row" style="gap:8px;margin-top:6px">
      <span id="cycle" class="pill">Loadingâ€¦</span>
      <label class="pill" for="search">Search</label>
      <input id="search" type="text" placeholder="Title, artist, figure, seedâ€¦">
      <select id="dayJump" aria-label="Jump to day"><option value="">Jump to dayâ€¦</option></select>
      <button id="reload" class="btn" type="button">Reload</button>
      <!-- FIXED: absolute links -->
      <a class="btn" href="https://tunes.plnt.earth/" target="_blank" rel="noopener">Open Tunes</a>
      <a class="btn" href="/day/" rel="noopener">Open Day Viewer</a>
      <a class="btn" href="/calendar/illumina1/" rel="noopener">View Calendar</a>
    </div>
    <p class="muted">Click any day to open the Day page. YouTube is canonical; Apple Music/Spotify appear on Tunes.</p>
  </header>

  <section class="card">
    <div class="cal">
      <div class="calHead">
        <span>Sun</span><span>Mon</span><span>Tue</span><span>Wed</span><span>Thu</span><span>Fri</span><span>Sat</span>
      </div>
      <div id="calGrid" class="calGrid" aria-live="polite"></div>
    </div>
  </section>

  <section class="grid cards" style="margin-top:12px">
    <div class="card">
      <h2>Links</h2>
      <div class="row" style="gap:10px">
        <!-- FIXED: absolute site-root links -->
        <a class="btn" href="/interludes/" target="_blank" rel="noopener">Interludes</a>
        <a class="btn" href="/references/" target="_blank" rel="noopener">References</a>
        <a class="btn" href="/science/" target="_blank" rel="noopener">Science</a>
        <a class="btn" href="/archive/" target="_blank" rel="noopener">Archive</a>
      </div>
    </div>

    <div class="card">
      <h2>About this cycle</h2>
      <p class="muted">The calendar pulls from a master JSON. Each day links to a Day page with an inline player and your Figure/Seed notes.</p>
    </div>
  </section>

  <footer class="muted" style="margin:24px 0 8px;text-align:center">PLNT Earth Â· Illumina</footer>
</div>

<!-- YouTube Iframe API -->
<script>
  (function(){ if(window.YT && YT.Player) return; var s=document.createElement('script'); s.src="https://www.youtube.com/iframe_api"; s.async=true; document.head.appendChild(s);} )();
</script>

<script>
(function(){
  /* Config */
  var MASTER_JSON = '/Illumina1_Playlist_MASTER_3in1.json';
  var LANE = 'Explainer';

  /* State */
  var data=null, filteredTerm='', playOrder=[], currentIndex=-1;
  var player, playerReady=false, queuedId=null;

  /* Els */
  var calGrid = document.getElementById('calGrid');
  var cycle = document.getElementById('cycle');
  var search = document.getElementById('search');
  var dayJump = document.getElementById('dayJump');
  var reloadBtn = document.getElementById('reload');
  var shareBtn = document.getElementById('shareBtn');
  var nowTitle = document.getElementById('nowTitle');
  var nowMeta = document.getElementById('nowMeta');
  var prevBtn = document.getElementById('prevBtn');
  var nextBtn = document.getElementById('nextBtn');

  function syncHeader(){ var h=document.querySelector('.playerbar').getBoundingClientRect().height; document.body.style.paddingTop=(Math.ceil(h)+8)+'px'; }
  window.addEventListener('resize', syncHeader, {passive:true}); window.addEventListener('orientationchange', syncHeader, {passive:true}); setTimeout(syncHeader,60);

  function safe(v){return v==null?'':String(v);}
  function moon(dateStr){ if(!dateStr) return ''; var d=new Date(dateStr+'T00:00:00Z'), syn=29.53058867, base=Date.UTC(2025,0,29); var days=(Date.UTC(d.getUTCFullYear(),d.getUTCMonth(),d.getUTCDate())-base)/86400000; var p=((days%syn)+syn)%syn; return ['ðŸŒ‘','ðŸŒ’','ðŸŒ“','ðŸŒ”','ðŸŒ•','ðŸŒ–','ðŸŒ—','ðŸŒ˜'][Math.floor((p/syn)*8+0.5)%8]; }
  function extractID(u){ if(!u) return ''; var m=String(u).match(/[?&]v=([^&]+)/)||String(u).match(/youtu\.be\/([^?&]+)/)||String(u).match(/embed\/([^?&]+)/); return m?m[1]:''; }
  function hasYT(row){ return !!(row && row.Platforms && row.Platforms.YouTube && row.Platforms.YouTube.url); }
  function match(row,fig,seed){ if(!filteredTerm) return true; var t=filteredTerm.toLowerCase(); return (safe(row.title).toLowerCase().includes(t)||safe(row.artist).toLowerCase().includes(t)||safe(fig).toLowerCase().includes(t)||safe(seed).toLowerCase().includes(t)); }

  function build(){
    if(!data||!data.PerDay){ calGrid.innerHTML=''; return; }
    var list=data.PerDay, start=list[0]&&list[0].Date?new Date(list[0].Date+'T00:00:00'):null, offset=start?new Date(start).getDay():0;
    playOrder=[];
    var cells=[];
    for(var i=0;i<offset;i++) cells.push('<div class="day" aria-hidden="true" style="opacity:.25"></div>');
    for(var k=0;k<list.length;k++){
      var base=list[k], d=base.Day, date=base.Date, row=base[LANE]||{}, fig=base.Figure, seed=base.SeedRitual;
      if(!match(row,fig,seed)) continue;
      var url = hasYT(row) ? row.Platforms.YouTube.url : '';
      if(url) playOrder.push(d);
      var href='/day/?date='+encodeURIComponent(date||'');
      cells.push(
        '<a class="day" href="'+href+'" id="d-'+d+'">'+
          '<div class="dtop"><span class="dnum">Day '+d+'</span><div class="dmeta"><span class="badge mono">'+safe(date)+'</span><span class="badge">'+moon(date)+'</span></div></div>'+
          '<div class="dtitle">'+safe(row.title)+'</div>'+
          '<div class="dartist">'+safe(row.artist)+'</div>'+
          (url?'<div class="badge">YouTube</div>':'<div class="badge" style="color:#f3c6c6">Missing</div>')+
        '</a>'
      );
    }
    calGrid.innerHTML=cells.join('');
    var opts=['<option value="">Jump to dayâ€¦</option>']; for(var j=0;j<list.length;j++) opts.push('<option value="'+(j+1)+'">Day '+(j+1)+'</option>'); dayJump.innerHTML=opts.join('');
  }

  function setNow(day){ var base=data.PerDay[day-1]||{}, row=base[LANE]||{}; nowTitle.textContent=safe(row.title||'â€”'); nowMeta.textContent=safe(row.artist||'â€”')+' Â· Day '+day+' Â· '+safe(base.Date||''); }
  function playByDay(day){ var row=(data.PerDay[day-1]||{})[LANE]||{}, url=row.Platforms&&row.Platforms.YouTube&&row.Platforms.YouTube.url, id=extractID(url); if(!id) return; setNow(day); currentIndex=playOrder.indexOf(day); if(player&&playerReady){player.loadVideoById(id);}else{queuedId=id;} var el=document.getElementById('d-'+day); if(el) el.scrollIntoView({behavior:'smooth',block:'start'}); }
  function next(){ if(playOrder.length===0) return; currentIndex = currentIndex<0?0:Math.min(currentIndex+1, playOrder.length-1); playByDay(playOrder[currentIndex]); }
  function prev(){ if(playOrder.length===0) return; currentIndex = currentIndex<=0?0:currentIndex-1; playByDay(playOrder[currentIndex]); }

  function render(){ if(!data||!data.PerDay){ cycle.textContent='No data'; return; } build(); var s=data.Cycle&&data.Cycle.Start?data.Cycle.Start:'â€”', e=data.Cycle&&data.Cycle.End?data.Cycle.End:'â€”'; cycle.textContent='Cycle: '+s+' â†’ '+e+' Â· Days: '+data.PerDay.length; }

  function load(){ fetch('/Illumina1_Playlist_MASTER_3in1.json',{cache:'no-store'}).then(r=>r.json()).then(json=>{data=json; render();}).catch(()=>{cycle.textContent='Load error'; calGrid.innerHTML='';}); }

  // UI
  search.addEventListener('input', function(){ filteredTerm=this.value.trim(); render(); });
  dayJump.addEventListener('change', function(){ var v=parseInt(this.value||'',10); if(v) location.href='/day/?day='+v; });
  reloadBtn.addEventListener('click', load);
  shareBtn.addEventListener('click', function(){ if(navigator.clipboard&&navigator.clipboard.writeText){ navigator.clipboard.writeText(location.href); this.textContent='Copied!'; var s=this; setTimeout(function(){s.textContent='Share';},900);} });
  prevBtn.addEventListener('click', prev); nextBtn.addEventListener('click', next);

  // YouTube API callback
  window.onYouTubeIframeAPIReady = function(){
    player = new YT.Player('yt', {
      width:'100%', height:'100%', playerVars:{rel:0,modestbranding:1,playsinline:1},
      events:{ onReady:function(){ playerReady=true; if(queuedId){player.loadVideoById(queuedId); queuedId=null;} },
               onStateChange:function(e){ if(e.data===YT.PlayerState.ENDED) next(); } }
    });
  };

  // init
  load();
})();
</script>
</body>
</html>
