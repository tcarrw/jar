<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Constellation â€¢ Illumina 1</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='46' fill='black'/><circle cx='40' cy='50' r='38' fill='white'/></svg>">
  <style>
    :root {
      --bg:#0b0b0c; --card:#141417; --text:#e9e9ef; --muted:#9a9aab; --accent:#b2f5ea; --ring:#2a2a33;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{background:var(--card);border-bottom:1px solid var(--ring);position:sticky;top:0;z-index:10}
    nav{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;flex-wrap:wrap;gap:16px}
    nav a{text-decoration:none;color:var(--text);font-size:14px}
    nav a:hover{color:var(--accent)}
    main{max-width:1100px;margin:0 auto;padding:24px 16px}
    h1{margin:8px 0}
    .meta{color:var(--muted);margin-bottom:12px}
    .panel{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;margin-bottom:16px}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    input[type="search"], select{background:#0e0e11;color:var(--text);border:1px solid var(--ring);border-radius:10px;padding:8px 10px}
    .chips{display:flex;gap:8px 10px;flex-wrap:wrap;margin-top:10px}
    .chip{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);border-radius:999px;padding:4px 8px;color:var(--muted);font-size:12px;cursor:pointer}
    .chip .dot{width:10px;height:10px;border-radius:50%}
    .chip.active{border-color:var(--accent);color:var(--accent)}
    svg{width:100%;height:560px;border:1px solid var(--ring);border-radius:12px;background:radial-gradient(1200px 600px at 30% 10%, rgba(178,245,234,.06), transparent)}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);border-radius:999px;padding:4px 8px;color:var(--muted);font-size:12px}
    .swatch{width:10px;height:10px;border-radius:50%}
    .btn{display:inline-block;border:1px solid var(--ring);border-radius:10px;padding:8px 14px;color:var(--text);text-decoration:none;background:none;cursor:pointer}
    .btn:hover{border-color:var(--accent);color:var(--accent)}
    #nores{display:none;margin-top:8px;color:var(--muted)}
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="/">Home</a>
      <a href="/calendar/illumina1/">Calendar</a>
      <a href="/day/">Day</a>
      <a href="/notes/moon/">Moon Notes</a>
      <a href="/notes/day/">Day Notes</a>
      <a href="/pantheon/">Pantheon</a>
      <a href="/pantheon/constellation/">Constellation</a>
      <a href="/victory/">Victory</a>
      <a href="/references/">References</a>
      <a href="/seeds/">Seeds</a>
      <a href="/science/">Science</a>
      <a href="/archive/">Archive</a>
      <a href="https://tunes.plnt.earth" target="_blank">Tunes â†—</a>
      <a href="https://youtube.com/playlist?list=PL2H7n7qLAdf7VTOrmFlY9G-PaE94VrHAY&si=vblXKmAvTj-Ve5iV" target="_blank">Playlist â†—</a>
    </nav>
  </header>

  <main>
    <h1>ðŸŒŒ Constellation</h1>
    <div class="meta">Interactive map of Illumina 1. Filter by figure, artist, phase, or search; click a star to open the Day. Chips are generated from data only (no stray labels).</div>

    <div class="panel">
      <div class="controls">
        <input id="q" type="search" placeholder="Search track / figureâ€¦" />
        <select id="fig"></select>
        <select id="artist"></select>
        <select id="phase">
          <option value="">All phases</option>
          <option>ðŸŒ• Full Moon</option>
          <option>ðŸŒ– Waning Gibbous</option>
          <option>ðŸŒ— Last Quarter</option>
          <option>ðŸŒ˜ Waning Crescent</option>
          <option>ðŸŒ‘ New Moon</option>
          <option>ðŸŒ’ Waxing Crescent</option>
          <option>ðŸŒ“ First Quarter</option>
          <option>ðŸŒ” Waxing Gibbous</option>
        </select>
        <button class="btn" id="toggleSpiral">Spiral 1/7</button>
        <button class="btn" id="reset">Reset</button>
      </div>
      <div class="chips" id="chips"></div>
      <svg id="sky" viewBox="0 0 1000 560" preserveAspectRatio="xMidYMid meet"></svg>
      <div id="nores">No matches for this filter.</div>
      <div class="legend" id="legend"></div>
    </div>
  </main>

  <script>
    const DATA_URL = "/data/illumina1.json";
    const colors = ["#E3B505","#4CC9F0","#F72585","#B5179E","#4895EF","#3A0CA3","#2A9D8F","#F4A261","#E76F51","#90BE6D","#577590","#FFD166","#06D6A0"];
    function hashCode(s){ let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; } return h; }
    function colorFor(key){ const i = Math.abs(hashCode(key)) % colors.length; return colors[i]; }
    function artistFromTrack(track){
      if(!track) return "";
      const seps = [" â€“ "," â€” "," - "];
      for(const sep of seps) if(track.includes(sep)) return track.split(sep)[0].trim();
      return track.split("â€“")[0].split("-")[0].trim();
    }
    function populate(sel, items, placeholder){
      sel.innerHTML = "";
      const o0 = document.createElement("option"); o0.value=""; o0.textContent = placeholder; sel.appendChild(o0);
      items.forEach(v=>{ const o=document.createElement("option"); o.value=v; o.textContent=v; sel.appendChild(o); });
    }
    function buildLegend(figures){
      const box = document.getElementById("legend"); box.innerHTML = "";
      figures.forEach(f=>{ const p=document.createElement("div"); p.className="pill";
        const sw=document.createElement("span"); sw.className="swatch"; sw.style.background=colorFor(f);
        const lab=document.createElement("span"); lab.textContent=f;
        p.appendChild(sw); p.appendChild(lab); box.appendChild(p);
      });
    }
    function layoutGrid(index){
      const cols=14; const col=index%cols; const row=Math.floor(index/cols);
      const mx=40,my=40; const cw=(1000-mx*2)/cols; const ch=(560-my*2)/3;
      return {x: mx+cw*col+cw/2, y: my+ch*row+ch/2};
    }
    function layoutSpiral(n){
      const cx=500, cy=280, a=8, b=12, angle=n*(Math.PI/6.5), r=a+b*Math.sqrt(n+1);
      return {x: cx+r*Math.cos(angle), y: cy+r*Math.sin(angle)};
    }
    function buildChips(figCounts){
      const bar = document.getElementById("chips"); bar.innerHTML="";
      const entries = Array.from(figCounts.entries()).sort((a,b)=>b[1]-a[1]);
      entries.forEach(([name,cnt])=>{
        const c=document.createElement("div"); c.className="chip"; c.dataset.value=name;
        const d=document.createElement("span"); d.className="dot"; d.style.background=colorFor(name);
        const t=document.createElement("span"); t.textContent=name;
        const n=document.createElement("span"); n.className="muted"; n.textContent=" "+cnt;
        c.appendChild(d); c.appendChild(t); c.appendChild(n);
        c.addEventListener("click",()=>{
          const sel = document.getElementById("fig");
          sel.value = (sel.value===name ? "" : name);
          Array.from(bar.children).forEach(el=>el.classList.toggle("active", el.dataset.value===sel.value));
          render(window.__DATA__, window.__SPIRAL__);
        });
        bar.appendChild(c);
      });
    }
    function setActiveChip(name){
      const bar = document.getElementById("chips");
      Array.from(bar.children).forEach(el=>el.classList.toggle("active", name && el.dataset.value===name));
    }
    function render(data, useSpiral){
      const svg=document.getElementById("sky"); svg.innerHTML="";
      const q=(document.getElementById("q").value||"").toLowerCase();
      const fig=document.getElementById("fig").value;
      const art=(document.getElementById("artist").value||"");
      const phase=document.getElementById("phase").value;
      const filtered = data.filter(d=>{
        const hay = `${d.Track} ${d.Figure}`.toLowerCase();
        const okQ = !q || hay.includes(q);
        const okFig = !fig || d.Figure===fig;
        const okArt = !art || artistFromTrack(d.Track)===art;
        const okPhase = !phase || d.MoonPhase===phase;
        return okQ && okFig && okArt && okPhase;
      });
      document.getElementById("nores").style.display = filtered.length ? "none" : "";
      const g=document.createElementNS("http://www.w3.org/2000/svg","g"); svg.appendChild(g);
      filtered.forEach(d=>{
        const idx = d.Day-1; const pos = useSpiral?layoutSpiral(idx):layoutGrid(idx);
        const group=document.createElementNS("http://www.w3.org/2000/svg","g");
        group.setAttribute("transform",`translate(${pos.x},${pos.y})`);
        const star=document.createElementNS("http://www.w3.org/2000/svg","circle");
        star.setAttribute("r","9"); star.setAttribute("fill", colorFor(d.Figure||d.Track||"x")); star.setAttribute("opacity","0.9"); star.style.cursor="pointer";
        star.addEventListener("click",()=>{ location.href=`/day/?n=${d.Day}`; });
        const label=document.createElementNS("http://www.w3.org/2000/svg","text");
        label.setAttribute("x","12"); label.setAttribute("y","5"); label.setAttribute("fill","#cfd3ff"); label.setAttribute("font-size","12"); label.textContent=d.Day;
        const tip=document.createElementNS("http://www.w3.org/2000/svg","title");
        tip.textContent = `Day ${d.Day} â€¢ ${d.MoonPhase}
${d.Track} (${d.Figure})`;
        star.appendChild(tip); group.appendChild(star); group.appendChild(label); g.appendChild(group);
      });
    }
    async function boot(){
      const res = await fetch(DATA_URL); const data = await res.json(); window.__DATA__ = data.slice();
      // Build selects from data (figures/artists only from JSON)
      const figures = Array.from(new Set(data.map(d=>d.Figure).filter(Boolean))).sort();
      const artists = Array.from(new Set(data.map(d=>artistFromTrack(d.Track)).filter(Boolean))).sort();
      populate(document.getElementById("fig"), figures, "All figures");
      populate(document.getElementById("artist"), artists, "All artists");
      // Build chips with counts
      const counts = new Map(); figures.forEach(f=>counts.set(f, 0)); data.forEach(d=>{ if(d.Figure) counts.set(d.Figure, (counts.get(d.Figure)||0)+1); });
      buildChips(counts);
      buildLegend(figures);
      // Prefill from ?figure=
      const qp=new URLSearchParams(location.search); const figure=qp.get("figure");
      if(figure){ const m=figures.find(f=>f.toLowerCase()===figure.toLowerCase()); if(m){ document.getElementById("fig").value=m; setActiveChip(m); } }
      // Render + wire handlers
      window.__SPIRAL__ = false; render(data, window.__SPIRAL__);
      document.getElementById("q").addEventListener("input", ()=>render(data, window.__SPIRAL__));
      document.getElementById("fig").addEventListener("change", (e)=>{ setActiveChip(e.target.value); render(data, window.__SPIRAL__); });
      document.getElementById("artist").addEventListener("change", ()=>render(data, window.__SPIRAL__));
      document.getElementById("phase").addEventListener("change", ()=>render(data, window.__SPIRAL__));
      document.getElementById("toggleSpiral").addEventListener("click", ()=>{ window.__SPIRAL__=!window.__SPIRAL__; render(data, window.__SPIRAL__); });
      document.getElementById("reset").addEventListener("click", ()=>{ document.getElementById("q").value=""; document.getElementById("fig").value=""; document.getElementById("artist").value=""; document.getElementById("phase").value=""; setActiveChip(""); render(data, window.__SPIRAL__); });
    }
    boot();
  </script>
</body>
</html>
