<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Constellation â€¢ jar.plnt.earth</title>
  <link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='46' fill='black'/><circle cx='40' cy='50' r='38' fill='white'/></svg>">
  <style>
    :root {
      --bg: #0b0b0c;
      --card: #141417;
      --text: #e9e9ef;
      --muted: #9a9aab;
      --accent: #b2f5ea;
      --ring: #2a2a33;
      --dot: rgba(255,255,255,.9);
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial;background:var(--bg);color:var(--text)}
    header{background:var(--card);border-bottom:1px solid var(--ring);position:sticky;top:0;z-index:10}
    nav{max-width:1100px;margin:0 auto;padding:12px 16px;display:flex;flex-wrap:wrap;gap:16px}
    nav a{text-decoration:none;color:var(--text);font-size:14px}
    nav a:hover{color:var(--accent)}
    main{max-width:1100px;margin:0 auto;padding:24px 16px}
    h1{margin:8px 0}
    .meta{color:var(--muted);margin-bottom:12px}
    .panel{background:var(--card);border:1px solid var(--ring);border-radius:16px;padding:16px;margin-bottom:16px}
    .controls{display:flex;gap:10px;flex-wrap:wrap}
    select,input[type="search"]{background:#0e0e11;color:var(--text);border:1px solid var(--ring);border-radius:10px;padding:8px 10px}
    svg{width:100%;height:560px;border:1px solid var(--ring);border-radius:12px;background:radial-gradient(1200px 600px at 30% 10%, rgba(178,245,234,.06), transparent)}
    .legend{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .pill{display:inline-flex;align-items:center;gap:6px;border:1px solid var(--ring);border-radius:999px;padding:4px 8px;color:var(--muted);font-size:12px}
    .swatch{width:10px;height:10px;border-radius:50%}
    .btn{display:inline-block;border:1px solid var(--ring);border-radius:10px;padding:8px 14px;color:var(--text);text-decoration:none;background:none;cursor:pointer}
    .btn:hover{border-color:var(--accent);color:var(--accent)}
  </style>
</head>
<body>
  <header>
    <nav>
      <a href="/">Home</a>
      <a href="/calendar/illumina1/">Calendar</a>
      <a href="/day/">Day</a>
      <a href="/notes/moon/">Moon Notes</a>
      <a href="/notes/day/">Day Notes</a>
      <a href="/pantheon/">Pantheon</a>
      <a href="/pantheon/constellation/">Constellation</a>
      <a href="/victory/">Victory</a><a href="/references/">References</a>
      <a href="/seeds/">Seeds</a>
      <a href="/archive/">Archive</a>
      <a href="https://tunes.plnt.earth" target="_blank">Tunes â†—</a>
      <a href="https://youtube.com/playlist?list=PL2H7n7qLAdf7VTOrmFlY9G-PaE94VrHAY&si=vblXKmAvTj-Ve5iV" target="_blank">Playlist â†—</a>
    </nav>
  </header>

  <main>
    <h1>ðŸŒŒ Constellation</h1>
    <div class="meta">Interactive map of Illumina 1. Filter by figure, phase, or search; click a star to open the Day.</div>

    <div class="panel">
      <div class="controls">
        <input id="q" type="search" placeholder="Search track / figureâ€¦" />
        <select id="fig"></select>
        <select id="artist" title="Artist (from Track)"><option value="">All artists</option></select>
          <option value="">All figures</option>
          <option>Sabrina</option>
          <option>Janet</option>
          <option>Eminem</option>
          <option>Emma</option>
          <option>Doechii</option>
          <option>Hot To Go</option>
          <option>Anonymous</option>
          <option>Greta</option>
          <option>Ariana</option>
          <option>Mac Miller</option>
          <option>Pink Floyd</option>
          <!-- Add more as they appear in CSV -->
        </select>
        <select id="phase">
          <option value="">All phases</option>
          <option>ðŸŒ• Full Moon</option>
          <option>ðŸŒ– Waning Gibbous</option>
          <option>ðŸŒ— Last Quarter</option>
          <option>ðŸŒ˜ Waning Crescent</option>
          <option>ðŸŒ‘ New Moon</option>
          <option>ðŸŒ’ Waxing Crescent</option>
          <option>ðŸŒ“ First Quarter</option>
          <option>ðŸŒ” Waxing Gibbous</option>
        </select>
        <button class="btn" id="toggleSpiral">Spiral 1/7</button>
      </div>
      <svg id="sky" viewBox="0 0 1000 560" preserveAspectRatio="xMidYMid meet"></svg>
      <div class="legend" id="legend"></div>
      <div id="nores" class="meta" style="display:none;margin-top:6px">No matches for this filter.</div>
    </div>
  </main>

  <script>
    const DATA_URL = "/data/illumina1.json";
    const colors = [
      "#E3B505","#4CC9F0","#F72585","#B5179E","#4895EF","#3A0CA3","#2A9D8F",
      "#F4A261","#E76F51","#90BE6D","#577590","#FFD166","#06D6A0"
    ];
    function artistFromTrack(track){
      if(!track) return "";
      const seps = [" â€“ ", " â€” ", " - "];
      for(const sep of seps){
        if(track.includes(sep)) return track.split(sep)[0].trim();
      }
      return track.split("â€“")[0].split("-")[0].trim();
    }
    function populateSelect(sel, items, placeholder){
      sel.innerHTML = "";
      const opt0 = document.createElement("option");
      opt0.value = "";
      opt0.textContent = placeholder;
      sel.appendChild(opt0);
      items.forEach(v=>{
        const o = document.createElement("option");
        o.value = v; o.textContent = v;
        sel.appendChild(o);
      });
    }
    function buildFigureAndArtistSelects(data){
      const figSel = document.getElementById("fig");
      const artistSel = document.getElementById("artist");
      const figures = Array.from(new Set(data.map(d=>d.Figure).filter(Boolean))).sort();
      const artists = Array.from(new Set(data.map(d=>artistFromTrack(d.Track)).filter(Boolean))).sort();
      populateSelect(figSel, figures, "All figures");
      populateSelect(artistSel, artists, "All artists");
      // Prefill from ?figure=
      const qp = new URLSearchParams(location.search);
      const figure = qp.get("figure");
      if(figure){
        const match = figures.find(f => f.toLowerCase() === figure.toLowerCase());
        if(match) figSel.value = match;
      }
    }
    function colorFor(key){
      const i = Math.abs(hashCode(key)) % colors.length;
      return colors[i];
    }
    function hashCode(s){
      let h=0; for(let i=0;i<s.length;i++){ h=((h<<5)-h)+s.charCodeAt(i); h|=0; }
      return h;
    }
    function buildLegend(figures){
      const box = document.getElementById("legend");
      box.innerHTML = "";
      figures.forEach(f=>{
        const pill = document.createElement("div");
        pill.className = "pill";
        const sw = document.createElement("span");
        sw.className = "swatch";
        sw.style.background = colorFor(f);
        const label = document.createElement("span");
        label.textContent = f;
        pill.appendChild(sw); pill.appendChild(label);
        box.appendChild(pill);
      });
    }
    function layoutGrid(index){
      const cols = 14; // 3 rows of 14 = 42
      const col = index % cols;
      const row = Math.floor(index / cols);
      const marginX = 40, marginY = 40;
      const cellW = (1000 - marginX*2) / cols;
      const cellH = (560 - marginY*2) / 3;
      const x = marginX + cellW*col + cellW/2;
      const y = marginY + cellH*row + cellH/2;
      return {x,y};
    }
    function layoutSpiral(n){
      // simple spiral; n is 0..41
      const cx=500, cy=280;
      const a = 8; // spacing
      const b = 12; // spiral growth
      const angle = n * (Math.PI/6.5);
      const r = a + b * Math.sqrt(n+1);
      const x = cx + r * Math.cos(angle);
      const y = cy + r * Math.sin(angle);
      return {x,y};
    }
    function render(data, useSpiral){
      const svg = document.getElementById("sky");
      const q = document.getElementById("q").value.toLowerCase();
      const figFilter = document.getElementById("fig").value;
      const artistFilter = (document.getElementById("artist")||{}).value || "";
      const phaseFilter = document.getElementById("phase").value;
      svg.innerHTML = "";
      const g = document.createElementNS("http://www.w3.org/2000/svg","g");
      svg.appendChild(g);

      const filtered = data.filter((d)=>{
        const hay = `${d.Track} ${d.Figure}`.toLowerCase();
        const okQ = !q || hay.includes(q);
        const okFig = !figFilter || d.Figure === figFilter;
        const artist = artistFromTrack(d.Track);
        const okArtist = !artistFilter || artist === artistFilter;
        const okPhase = !phaseFilter || d.MoonPhase === phaseFilter;
        return okQ && okFig && okPhase && okArtist;
      });

      document.getElementById('nores').style.display = filtered.length ? 'none' : '';
      filtered.forEach((d, i)=>{
        const idx = d.Day - 1;
        const pos = useSpiral ? layoutSpiral(idx) : layoutGrid(idx);
        const group = document.createElementNS("http://www.w3.org/2000/svg","g");
        group.setAttribute("transform", `translate(${pos.x},${pos.y})`);

        const star = document.createElementNS("http://www.w3.org/2000/svg","circle");
        star.setAttribute("r","9");
        star.setAttribute("fill", colorFor(d.Figure || d.Track || "x"));
        star.setAttribute("opacity","0.9");
        star.style.cursor = "pointer";
        star.addEventListener("click", ()=>{
          window.location.href = `/day/?n=${d.Day}`;
        });
        const label = document.createElementNS("http://www.w3.org/2000/svg","text");
        label.setAttribute("x","12");
        label.setAttribute("y","5");
        label.setAttribute("fill","#cfd3ff");
        label.setAttribute("font-size","12");
        label.textContent = d.Day;

        const tip = document.createElementNS("http://www.w3.org/2000/svg","title");
        tip.textContent = `Day ${d.Day} â€¢ ${d.MoonPhase}\n${d.Track} (${d.Figure})`;
        star.appendChild(tip);

        group.appendChild(star);
        group.appendChild(label);
        g.appendChild(group);
      });
    }

    async function boot(){
      const res = await fetch("/data/illumina1.json");
      const data = await res.json();
      // Legend from observed figures
      const figures = Array.from(new Set(data.map(d=>d.Figure))).filter(Boolean);
      buildLegend(figures);
      buildFigureAndArtistSelects(data);

      let spiral = false;
      render(data, spiral);
      document.getElementById("q").addEventListener("input", ()=>render(data, spiral));
      document.getElementById("fig").addEventListener("change", ()=>render(data, spiral));
      document.getElementById("phase").addEventListener("change", ()=>render(data, spiral));
      document.getElementById("artist").addEventListener("change", ()=>render(data, spiral));
      document.getElementById("toggleSpiral").addEventListener("click", ()=>{
        spiral = !spiral;
        render(data, spiral);
      });

      // Preselect from query param ?figure=Name
      const qp = new URLSearchParams(location.search);
      const figure = qp.get("figure");
      if(figure){
        const opt = Array.from(document.getElementById("fig").options).find(o=>o.value.toLowerCase()===figure.toLowerCase());
        if(opt){ document.getElementById("fig").value = opt.value; render(data, spiral); }
      }
    }
    boot();
  </script>
</body>
</html>
